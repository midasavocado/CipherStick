<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CipherStick: The Abyss Protocol</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Confetti + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase compat SDK setup (required before any Firebase usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    :root {
      --accent-color: #00bfff; /* Deep blue for abyss theme */
      --text-color: #d5ffd5;
      --border-hover: rgba(0, 255, 0, 0.4);
      --warning-color: #39ff14;
      --danger-color: #ff5555;
      --success-color: #00ff00;
    }

    /* Reset & Box Sizing */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* BODY: With background image + an optional subtle black overlay */
    body {
      font-family: 'Open Sans', sans-serif;
      background: url('abyss_BG.png') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 0 1rem 1rem 1rem;
      color: var(--text-color);
      text-shadow: 1px 1px 3px #000; /* Add shadow for readability */
    }
    /* If you want a subtle overlay to help text clarity, uncomment:
    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      pointer-events: none;
      z-index: -1;
    }
    */

    /* HEADER: no background so it blends in */
    header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      box-shadow: none;
    }
    header img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* MAIN CONTAINER: Transparent, so background shows through */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: transparent; /* fully transparent container */
      border-radius: 15px;
      box-shadow: none; /* removing heavy shadows if you want it truly transparent */
      flex: 1;
      margin-top: calc(100vw * 0.18);
      padding: 1rem;
    }

    .intro {
      margin-bottom: 2rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.6); /* Keep it transparent */
      border-left: 4px solid var(--accent-color);
      border-radius: 8px;
      font-size: 1.1rem;
      line-height: 1.6;
    }

    .intro p {
      margin-bottom: 1rem;
    }

    /* DETAILS + SUMMARY box for OSINT Tools */
    details {
      background: rgba(0, 0, 0, 0.6);
      border-left: 4px solid var(--accent-color);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    summary {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      list-style: none;
      outline: none;
      color: var(--text-color);
      text-shadow: 1px 1px 2px #000;
    }
    details ul li {
      margin: 0.5rem 0;
    }

    /* QUESTION BLOCKS */
    .question {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: black; /* Make it truly see-through */
      box-shadow: none;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    .question:hover {
      border-color: white;
    }
    .question .question-text {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1.1rem;
      color: white;
      margin-bottom: 0.5rem;
      text-shadow: 1px 1px 2px #000;
    }
    .question .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .question input[type="text"] {
      flex: 1;
      padding: 0.6rem;
      font-size: 1rem;
      color: var(--text-color);
      background-color: rgba(0,0,0,0.5); /* Slightly dark to show text clearly */
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      text-shadow: none; /* remove text shadow for inputs if you prefer */
    }
    .question input[type="text"]:focus {
      border-color: white;
      outline: none;
      box-shadow: 0 0 8px var(--border-hover);
    }

    /* HINT + CHECK BUTTONS */
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }
    .btn-hint, .btn-check {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
      color: #fff;
      text-shadow: none;
    }
    .btn-hint {
      background: linear-gradient(135deg, #444, #777);
    }
    .btn-hint:hover {
      background: linear-gradient(135deg, #777, #999);
      transform: translateY(-3px);
    }
    .btn-check {
      background: linear-gradient(135deg, #00aa00, #006600);
    }
    .btn-check:hover {
      background: linear-gradient(135deg, #00ff00, #009900);
      transform: translateY(-3px);
    }

    /* HINT */
    .hint {
      margin-top: 0.5rem;
      background: rgba(0,0,0,0.5);
      border-left: 4px solid var(--accent-color);
      padding: 0.5rem;
      border-radius: 6px;
      font-style: italic;
      color: #fff;
      display: none;
    }

    /* RESULT TEXT */
    .result {
      font-weight: bold;
      margin-top: 0.5rem;
      font-size: 1rem;
      min-height: 1.2rem;
      color: var(--warning-color);
      text-shadow: 1px 1px 2px #000;
    }
    .result.incorrect {
      color: var(--danger-color);
    }

    /* TOAST */
    #toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.7);
      animation: slideIn 0.5s ease-out;
      color: #fff;
      background: #b30000;
      font-family: 'Poppins', sans-serif;
      text-shadow: none;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* FINAL MESSAGE */
    #finalMessage {
      text-align: center;
      margin-top: 2rem;
      padding: 1.5rem;
      border: 2px solid var(--warning-color);
      border-radius: 10px;
      background: rgba(0,0,0,0.5);
      color: var(--warning-color);
      font-family: 'Poppins', sans-serif;
      display: none;
      text-shadow: 1px 1px 2px #000;
    }
    #finalMessage h2 {
      color: var(--warning-color);
      margin-bottom: 1rem;
      text-shadow: 1px 1px 2px #000;
    }

    /* VICTORY OVERLAY */
    #victoryOverlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Poppins', sans-serif;
      font-size: 3rem;
      color: var(--warning-color);
      background: rgba(0,0,0,0.8);
      padding: 2rem 4rem;
      border-radius: 10px;
      z-index: 1500;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
      text-shadow: 1px 1px 3px #000;
    }

    /* NAME INPUT MODAL */
    .name-input-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
      z-index: 2000;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      color: #fff;
    }
    .name-input-modal input {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #333;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border-radius: 6px;
      margin-bottom: 1rem;
      width: 80%;
      text-shadow: none;
    }
    .name-input-modal button {
      padding: 0.75rem 1.5rem;
      background: var(--warning-color);
      color: #111;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      text-shadow: none;
    }
    .name-input-modal button:hover {
      background: #d4ac0d;
      transform: scale(1.05);
    }

    /* CERTIFICATE BUTTON */
    .btn-certificate {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, #00b11b, #00b11b);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: background 0.3s ease, transform 0.3s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.5);
      text-shadow: none;
    }
    .btn-certificate:hover {
      background: linear-gradient(135deg, #00b11b, #00b11b);
      transform: translateY(-3px);
    }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 1rem;
      color: #ccc;
      font-size: 0.9rem;
      margin-top: 1rem;
      text-shadow: 1px 1px 2px #000;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      header img { height: auto; }
      .container { padding: 1rem; }
      .question { padding: 0.8rem; }
      .btn-hint, .btn-check { padding: 0.5rem 1rem; font-size: 0.9rem; }
      #victoryOverlay { font-size: 2rem; padding: 1rem 2rem; }
    }
    @media print {
      body { background: #fff !important; color: #000; }
      header, footer, .container { display: none !important; }
    }
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M2NFQ1M6LR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M2NFQ1M6LR');
</script>
<body>
  <header>
    <a href="index.html">
    <img src="ABYSS.png" alt="CipherStick: Abyss"/>
  </a>
  </header>

  <div class="container">
    <div class="intro" id="introText">
    </div>
    <details style="margin: 1rem 0; background: rgba(0, 0, 0, 0.6); border-left: 5px solid var(--accent-color); padding: 1rem; border-radius: 8px;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem;">🧰 Useful OSINT Tools (click to expand)</summary>
      <ul style="margin-top: 0.75rem; padding-left: 1.2rem; line-height: 1.7;">
        <li><a href="https://www.metadata2go.com/" target="_blank" style="color: #fff;">📷 Metadata2Go</a> – Extract metadata from images</li>
        <li style="color: #fff;">🛠 Browser <strong>Inspect Tool</strong> – Right click → Inspect → View source & elements</li>
        <li><a href="https://www.base64decode.org/" target="_blank" style="color: #fff;">📂 Base64 Decode</a> – Decode encoded strings</li>
        <li><a href="https://www.gps-coordinates.net/" target="_blank" style="color: #fff;">📍 GPS Coordinates Lookup</a></li>
        <li><a href="https://archive.org/web/" target="_blank" style="color: #fff;">🕰️ Wayback Machine</a> – View old versions of websites</li>
        <li><a href="https://www.osintcurio.us/" target="_blank" style="color: #fff;">🔍 OSINT Curious Project</a> – Great OSINT blog & tools</li>
        <li><a href="https://dnsdumpster.com/" target="_blank" style="color: #fff;">🌐 DNSDumpster</a> – DNS recon & infrastructure mapping</li>
        <li><a href="https://www.shodan.io/" target="_blank" style="color: #fff;">🛰️ Shodan</a> – Scan internet-connected devices</li>
        <li><a href="https://exif.tools/" target="_blank" style="color: #fff;">🧬 EXIF.tools</a> – Analyze hidden metadata in images</li>
        <li><a href="https://haveibeenpwned.com/" target="_blank" style="color: #fff;">🕵️‍♂️ Have I Been Pwned</a> – Check for compromised emails</li>      
        <li>IMPORTANT NOTE: Some of these sites may not be used in this puzzle, and there may be some other sites needed throught the challenge. With OSINT, you have to be prepared for everything.</li>
      </ul>
    </details>

    <details style="margin: 1rem 0; background: rgba(0, 0, 0, 0.6); border-left: 5px solid var(--accent-color); padding: 1rem; border-radius: 8px;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem;">📝 Feedback Form</summary>
      <div style="margin-top: 1rem; text-align: center;">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSf6Au1H3w5a0FtKkBG1M3t9H8KDCL79WsZBvCVVZCOihMdFrQ/viewform?usp=sharing&ouid=114401666501663284939"
           target="_blank"
           style="background:#00aa00; color:#fff; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: bold; text-decoration: none;
                  box-shadow: 0 4px 10px rgba(0,0,0,0.3); display:inline-block;">
          📝 Submit Feedback on This New Challenge
        </a>
      </div>
    </details>

    <div id="questionsContainer"></div>

    <div id="finalMessage">
      <h2 style="color: #ffcc00;">You beat it!</h2>
      <button class="btn-certificate" onclick="openCertificateModal()">Claim Your Certificate</button>
    </div>
    <div id="formReminder" style="text-align:center; margin-top:1rem; display:none;">
      <p style="color:#0f0; font-weight:bold;">New Challenge! Before you go, please fill out our short feedback form:</p>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSf6Au1H3w5a0FtKkBG1M3t9H8KDCL79WsZBvCVVZCOihMdFrQ/viewform?usp=sharing&ouid=114401666501663284939" target="_blank" style="color:#00ff00; text-decoration:underline;">Submit Feedback Form</a>
    </div>
  </div>

  <div id="victoryOverlay">You beat it! <p style="color: white; font-size: 12px; text-align: center;">Scroll down to claim your certificate!</p></div>

  <div id="nameInputModal" class="name-input-modal">
    <h2 style="color: #ffcc00;">Enter Your Name</h2>
    <input type="text" id="userNameInput" placeholder="Your Name" />
    <button onclick="downloadCertificate()">Download Certificate</button>
  </div>

  <div id="toast"></div>

  <footer>
    <p>© 2025 CipherStick. All rights reserved.</p>
  </footer>

<script>
function logCompletion() {
    if (testMode) {
      console.warn("🚫 Test mode active — skipping completion logging.");
      return;
    }
    function innerWrite() {
      if (!window.authUID) {
        setTimeout(innerWrite, 200);
        return;
      }
      const uid = window.authUID;
      // Use "abyss" as database record path
      const completionsRef = firebase.database().ref("completions/abyss/" + uid);
      const attemptsRef = firebase.database().ref("attempts/abyss/" + uid);
      console.log("🔄 Checking completions and attempts for user...");
      // Fetch attempts and completions
      attemptsRef.once("value").then((attemptSnap) => {
        const attemptsVal = attemptSnap.val();
        let attemptsCount = 0;
        if (attemptsVal && typeof attemptsVal === 'object') {
          attemptsCount = Object.keys(attemptsVal).length;
        }
        completionsRef.once("value").then((completionSnap) => {
          const completionsVal = completionSnap.val();
          let completionsCount = 0;
          if (completionsVal && typeof completionsVal === 'object') {
            completionsCount = Object.keys(completionsVal).length;
          } else if (completionSnap.exists()) {
            completionsCount = 1;
          }
          // Save completion (allow multiple completions, use push for consistency)
          const newCompletionKey = firebase.database().ref().push().key;
          const updateData = {};
          updateData[newCompletionKey] = { timestamp: Date.now() };
          completionsRef.update(updateData)
            .then(() => {
              console.log("✅ Completion logged");
            })
            .catch(error => {
              console.warn("❌ Completion logging failed:", error);
            });
        });
      });
    }
    innerWrite();
  }

function loadIntroText() {
  const introHTML = `
    <p>Welcome to <strong>The Abyss Protocol</strong>, a CipherStick challenge surrounding a lost submarine, a hidden satellite uplink, and a leak nobody saw coming. <br><br>In late-spring 2024, a classified submarine codenamed USS Acheron slipped off naval tracking grids during a clandestine Arctic run. Nothing hit the news—until 98 days later, when a disgraced SEAL cryptologist named Commander Rylan “Ghost” Vance leaked a lone link: 

AcheronLeaks.netlify.app

That’s where your investigation begins. Your briefing is simple:
<br><br>
Uncover why Acheron went dark, how it kept phoning an unknown satellite, and who now holds the kill-switch.
<br><br>
Your investigation begins at:</p>
    <p><a href="https://acheronLeaks.netlify.app" target="_blank" style="color:#0f0;">AcheronLeaks.netlify.app</a></p>
    <p>All answers must be in the format <code>${requiredPrefix}</code>ANSWER<code>${requiredSuffix}</code>.</p>
    All link answers must be in the format ab{https://example.com/}<br><br>
    <p>Good luck, Agent.</p>
    
  `;
  document.getElementById("introText").innerHTML = introHTML;
}


// New Abyss Protocol question data (base64-encoded)
const q = `WwogIHsKICAgICJxdWVzdGlvbiI6ICJIb3cgbWFueSBmcmFtZXMgYXJlIGluIHRoZSBmaXJzdCB2aWRlbyB5b3UgY29tZSBhY3Jvc3M/IiwKICAgICJoaW50IjogIiIKICB9LAogIHsKICAgICJxdWVzdGlvbiI6ICJXaGljaCB3ZWJzaXRlIGRvZXMgdGhhdCB2aWRlbyBwb2ludCB0bz8iLAogICAgImhpbnQiOiAiVHJ5IHZpZXdpbmcgdGhlIHZpZGVvIGZyYW1lIGJ5IGZyYW1lLiIKICB9LAogIHsKICAgICJxdWVzdGlvbiI6ICJXaGF0IGlzIHRoZSBmaWxlbmFtZSBvZiB0aGUgZmlsZSB0aGF0IHRoZSB3ZWJzaXRlIGdpdmVzIHlvdT8iLAogICAgImhpbnQiOiAiSW5zdGVhZCBvZiB2aWV3aW5nIHRoZSBwYWdlIGRpcmVjdGx5LCB0cnkgY3VybGluZyBpdC4iCiAgfSwKICB7CiAgICAicXVlc3Rpb24iOiAiV2hlcmUgZG9lcyB0aGF0IHBpY3R1cmUgdGFrZSB5b3UgdG8/IiwKICAgICJoaW50IjogIlNjYW4gdGhlIFFSIGNvZGUiCiAgfSwKICB7CiAgICAicXVlc3Rpb24iOiAiV2hhdCBpcyB0aGUgaGlkZGVuLCBlbmNvZGVkIG1lc3NhZ2Ugb24gdGhhdCBzaXRlPyIsCiAgICAiaGludCI6ICJUcnkgY29udmVydGluZyB0aGUgYmFzZTY0IGZyb20gUGFzdGVCaW4gaW50byBhbiBpbWFnZSIKICB9LAogIHsKICAgICJxdWVzdGlvbiI6ICJXaGF0IGRvZXMgdGhlIGltYWdlIHRoYXQgd2FzIHNoYXJlZCB3aXRoIHlvdSB0ZWxsIHlvdSB0byBkbz8iLAogICAgImhpbnQiOiAiRW1haWwgdGhlIGVtYWlsIHRoYXQgeW91IGZvdW5kIGluIHRoZSBiYXNlNjQgZW5jb2RlZCBpbWFnZSwgYW5kIHdhaXQgZm9yIGEgcmVwbHkuIgogIH0sCiAgewogICAgInF1ZXN0aW9uIjogIkhvdyBtYW55IGZpbGVzIGFyZSBpbnNpZGUgdGhlIGhpZGRlbiBaSVA/IiwKICAgICJoaW50IjogIk9wZW4gdGhlIGltYWdlIGluIGEgdGV4dCBlZGl0b3IsIHRoZW4gc2Nyb2xsIGRvd24gdG8gZmluZCBzb21lIGVuY29kZWQgYmFzZTY0LiBEZWNvZGUgdGhhdCB0byBhIGZpbGUuIgogIH0sCiAgewogICAgInF1ZXN0aW9uIjogIldoYXQgZG9lcyBrZXkudHh0IHRlbGwgeW91IHRvIGRvPyIsCiAgICAiaGludCI6ICJQYXN0ZSB0aGUgZW50aXJlIGRlY29kZWQgYmFzZTY0IHN0cmluZyBpbnRvIHRoZSBhbnN3ZXIuIgogIH0sCiAgewogICAgInF1ZXN0aW9uIjogIldoYXQgbGluayBkb2VzIHRoZSBhdWRpbyBmaWxlIGhpZGU/IiwKICAgICJoaW50IjogIk9wZW4gaGlkZGVuLndhdiBpbiBhbiBhdWRpbyBlZGl0b3IgYXBwbGljYXRpb24gc3VjaCBhcyBBdWRhY2l0eSBhbmQgc2V0IHRoZSB2aWV3aW5nIHR5cGUgdG8g4oCcc3BlY3Ryb2dyYW3igJ0gdG8gdmlldyB0aGUgaGlkZGVuIGxpbmsiCiAgfSwKICB7CiAgICAicXVlc3Rpb24iOiAiV2hhdCBpcyB0aGUgdXBsaW5rIHN0YXR1cz8iLAogICAgImhpbnQiOiAiIgogIH0sCiAgewogICAgInF1ZXN0aW9uIjogIldoYXQgaXMgdGhlIG5hbWUgb2YgdGhlIHNhdGVsbGl0ZSB0aGF0IHRoZSBzdWJtYXJpbmUgd2FzIGxpbmtpbmcgdG8/IiwKICAgICJoaW50IjogIiIKICB9LAogIHsKICAgICJxdWVzdGlvbiI6ICJXaG8gc2Fib3RhZ2VkIHRoZSBzdWJtYXJpbmU/IiwKICAgICJoaW50IjogIlRoZSBhbnN3ZXIgaXMgaW4gYW5vdGhlciBwdXp6bGUuIgogIH0KXQ==`;
const decoder = new TextDecoder('utf-8');
const jsonString = decoder.decode(Uint8Array.from(atob(q), c => c.charCodeAt(0)));
const questions = JSON.parse(jsonString);


const storageKeyPrefix = "OSINT-ABYSS";
const requiredPrefix = "ab{";
const requiredSuffix = "}";
const prefixEnabled = requiredPrefix.trim() !== "";
let quizCompleted = false;
let checkedQuestions = new Array(questions.length).fill(false);
let answeredCorrectly = new Array(questions.length).fill(false);

// --- Prefetch all answers for placeholders ---
async function fetchAllAnswers() {
  try {
    const res = await fetch("https://validate-answer.mwsaulsbury.workers.dev/all", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ challenge: "abyss" })
    });
    if (!res.ok) throw new Error(`status ${res.status}`);
    const { answers } = await res.json();
    answers.forEach((ans, i) => (questions[i].answer = ans));
  } catch (err) {
    console.warn("❌ Prefetch ABYSS answers failed:", err);
  }
}

function generatePlaceholder(answer) {
  const prefix = requiredPrefix || "";
  const suffix = requiredSuffix || "";
  if (!answer) return "";
  const core = answer.slice(prefix.length, answer.length - suffix.length);
  return `**{${core.replace(/[^{} ]/g, "*")}}`;
}

function normalizeInput(str) {
  return str.toLowerCase()
    .replace(/[’‘]/g, "'")
    .replace(/[“”]/g, '"')
    .normalize("NFKC")
    .trim();
}

function showToastMessage(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.background = (type === "correct") ? "#28a745" : "#e74c3c";
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

  function checkAnswer(index, showBanner = true) {
    const inputField = document.getElementById(`input-${index}`);
    const userInputRaw = inputField.value;
    const userInput = normalizeInput(userInputRaw);
    const expected = normalizeInput(`${requiredPrefix}${questions[index].answer}${requiredSuffix}`);
    const questionDiv = document.getElementById(`question-${index}`);
    const questionText = questionDiv.firstChild

    localStorage.setItem(`${storageKeyPrefix}-input-${index}`, userInputRaw);
    if (userInput !== "") checkedQuestions[index] = true;

    // Support for batch validation (single or array)
    // Here we keep single validation, but if you want to batch, call with array
    fetch('https://validate-answer.mwsaulsbury.workers.dev/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        challenge: "abyss",
        questionIndex: index,
        answer: `${userInput}`
      })
    })
      .then(res => res.json())
      .then(data => {
        // If API returns array, pick the first item (for backward compatibility)
        const result = Array.isArray(data) ? data[0] : data;
        if (result.correct) {
          if (!answeredCorrectly[index]) {
            answeredCorrectly[index] = true;
            questionDiv.style.borderColor = 'green';
            inputField.style.backgroundColor = "rgba(0, 255, 0, 0.1)";
            questionText.style.color = "rgb(0,255,0)";
            inputField.style.borderColor = "rgb(0,255,0)";
            if (showBanner) {
              showToastMessage("Correct!", "correct");
              confetti({ particleCount: 150, spread: 160, origin: { y: 0.6 } });
            }
          }
        } else {
          questionDiv.style.borderColor = 'red';
          inputField.style.backgroundColor = "rgba(255, 0, 0, 0.1)";
          questionText.style.color = "rgb(255,0,0)";
          inputField.style.borderColor = "rgb(255,0,0)";
          if (showBanner) {
            showToastMessage(`Incorrect answer for question ${index + 1}`, "incorrect");
          }
        }
        checkAllAnswers();
      })
      .catch(err => {
        console.error("Validation error:", err);
        showToastMessage("Error validating answer with server", "incorrect");
        // Still call checkAllAnswers to keep UI logic consistent
        checkAllAnswers();
      });
  }

function checkAllAnswers() {
  const finalMessage = document.getElementById('finalMessage');
  let allCorrect = true;
  for (let i = 0; i < questions.length; i++) {
    const inputVal = normalizeInput(document.getElementById(`input-${i}`).value);
    const expected = normalizeInput(`${requiredPrefix}${questions[i].answer}${requiredSuffix}`);
    if (inputVal !== expected || !checkedQuestions[i]) {
      allCorrect = false;
      break;
    }
  }
  if (allCorrect && !quizCompleted) {
    quizCompleted = true;
    finalMessage.style.display = 'block';
    document.getElementById("formReminder").style.display = "block";
    startVictoryConfetti();
    showVictoryOverlay();
    logCompletion();
     Object.keys(localStorage).forEach(key => {
  if (!key.includes("cipherstick-anon")) {
    localStorage.removeItem(key);
    console.log("REMOVED LOCALSTORAGE")
  }
});
    setTimeout(() => {
    // Freeze all input and textarea fields
    document.querySelectorAll("input, textarea").forEach(el => {
  //    el.readOnly = true;
    });
    console.log('🔒 All input and textarea fields set to readOnly');
    // Disable all buttons except download/print buttons
    document.querySelectorAll("button").forEach(btn => {
      if (!btn.id.includes("downloadBtn") && !btn.id.includes("printBtn")) {
      //  btn.disabled = true;
      }
    });
    console.log('🔒 All buttons disabled except certificate download/print');
    // Clear all localStorage and sessionStorage except userId
    // Try to preserve userId (from localStorage or sessionStorage)
    let userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
    localStorage.clear();
    sessionStorage.clear();
    if (userId) {
      localStorage.setItem('userId', userId);
      sessionStorage.setItem('userId', userId);
      console.log('🗝️ userId preserved in localStorage/sessionStorage');
    }
    console.log('🧹 Cleared localStorage and sessionStorage (except userId)');
  }, 200); // slight delay to ensure download triggers before disabling
  } else if (!allCorrect) {
    finalMessage.style.display = 'none';
    quizCompleted = false;
    document.getElementById("formReminder").style.display = "none";
  }
}

function toggleHint(index) {
  const hint = document.getElementById(`hint-${index}`);
  hint.style.display = (hint.style.display === 'none' || hint.style.display === '') ? 'block' : 'none';
}

function generateQuestions() {
  const container = document.getElementById('questionsContainer');
  questions.forEach((q, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question';
    questionDiv.id = `question-${index}`;

    const questionText = document.createElement('div');
    questionText.className = 'question-text';
    questionText.textContent = `${index + 1}. ${q.question}`;
    questionDiv.appendChild(questionText);

    const inputGroup = document.createElement('div');
    inputGroup.className = 'input-group';

    const input = document.createElement('input');
    input.type = 'text';
    input.id = `input-${index}`;
    // A simple placeholder that hides actual text:
    const answer = `${requiredPrefix}${q.answer}${requiredSuffix}`;
    input.placeholder = generatePlaceholder(answer);
    input.oninput = () => localStorage.setItem(`${storageKeyPrefix}-input-${index}`, input.value);
    inputGroup.appendChild(input);

    const btnGroup = document.createElement('div');
    btnGroup.className = 'btn-group';

    if (q.hint) {
      const hintBtn = document.createElement('button');
      hintBtn.className = 'btn-hint';
      hintBtn.textContent = 'Show Hint';
      hintBtn.onclick = () => toggleHint(index);
      btnGroup.appendChild(hintBtn);
    }

    const checkBtn = document.createElement('button');
    checkBtn.className = 'btn-check';
    checkBtn.textContent = 'Check Answer';
    checkBtn.onclick = () => checkAnswer(index, true);
    btnGroup.appendChild(checkBtn);

    inputGroup.appendChild(btnGroup);
    questionDiv.appendChild(inputGroup);

    if (q.hint) {
      const hintDiv = document.createElement('div');
      hintDiv.className = 'hint';
      hintDiv.id = `hint-${index}`;
      hintDiv.textContent = q.hint;
      questionDiv.appendChild(hintDiv);
    }

    const resultDiv = document.createElement('div');
    resultDiv.className = 'result';
    resultDiv.id = `result-${index}`;
    questionDiv.appendChild(resultDiv);

    container.appendChild(questionDiv);
  });
}

function restoreInputs() {
  questions.forEach((_, i) => {
    const saved = localStorage.getItem(`${storageKeyPrefix}-input-${i}`);
    if (saved) {
      const inputField = document.getElementById(`input-${i}`);
      inputField.value = saved;
      checkAnswer(i, false);
    }
  });
}

function startVictoryConfetti() {
  const interval = setInterval(() => {
    confetti({ particleCount: 300, spread: 150, origin: { x: 0, y: 0.5 } });
    confetti({ particleCount: 300, spread: 150, origin: { x: 1, y: 0.5 } });
  }, 350);
  setTimeout(() => clearInterval(interval), 10000);
}

function showVictoryOverlay() {
  const overlay = document.getElementById('victoryOverlay');
  overlay.style.opacity = '1';
  setTimeout(() => { overlay.style.opacity = '0'; }, 3000);
}

function openCertificateModal() {
  const modal = document.getElementById('nameInputModal');
  // Insert close button if not already present
  modal.style.display = 'block';
}

function downloadCertificate() {
  const userName = document.getElementById('userNameInput').value || '[Your Name]';

  // Send email via EmailJS
  emailjs.send("service_mpx4p0t", "certificate_claimed", {
    user_name: userName,
    quiz_difficulty: "ABYSS"
  }).then(function(response) {
    console.log("✅ Email sent!", response.status, response.text);
  }, function(error) {
    console.error("❌ Failed to send email", error);
  });

  const certificateDate = new Date().toLocaleDateString();
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF({ orientation: 'landscape', unit: 'in', format: [11, 8.5] });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  // Abyss-themed certificate (deep blue)
  doc.setFillColor(0, 20, 60);
  doc.rect(0, 0, pageWidth, pageHeight, 'F');

  doc.setDrawColor(0, 191, 255);
  doc.setLineWidth(0.25);
  doc.rect(0.25, 0.25, pageWidth - 0.5, pageHeight - 0.5);

  doc.setFont('times', 'bolditalic');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(28);
  doc.text('Certificate of Achievement', pageWidth / 2, 1.5, { align: 'center' });

  doc.setFontSize(18);
  doc.text('This certifies that', pageWidth / 2, 2.5, { align: 'center' });

  doc.setFontSize(24);
  doc.text(userName, pageWidth / 2, 3.5, { align: 'center' });

  doc.setFontSize(18);
  doc.text('has successfully completed', pageWidth / 2, 4.5, { align: 'center' });
  doc.text('CipherStick: ABYSS - The Abyss Protocol', pageWidth / 2, 5, { align: 'center' });

  doc.setFontSize(16);
  doc.text(`on ${certificateDate}`, pageWidth / 2, 5.5, { align: 'center' });
  doc.text('Awarded by: CipherStick Team', pageWidth / 2, 6.5, { align: 'center' });

  doc.setFontSize(14);
  doc.text('This achievement recognizes your elite investigative ability and OSINT expertise.', pageWidth / 2, 7.5, { align: 'center' });

  // Trigger download
  doc.save("AbyssProtocol-Certificate.pdf");
  // Firebase completion logging (runs only when certificate is generated)

  // --- Freeze all input fields and disable buttons, clear storage but preserve userId ---

  document.getElementById('nameInputModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  loadIntroText();
  fetchAllAnswers().then(() => {
    generateQuestions();
    restoreInputs();

    // --- TEST MODE AUTOFILL (new logic) ---
    const urlParams = new URLSearchParams(window.location.search);
    const testMode = urlParams.has('test');

    if (testMode) {
      const confirmed = confirm("Test mode is ON. All answers will be filled in automatically, and Firebase logging will be skipped.");
      if (confirmed) {
        questions.forEach((q, i) => {
          const input = document.getElementById(`input-${i}`);
         input.value = `${requiredPrefix}${q.answer}${requiredSuffix}`;
  if (!testMode) {
    localStorage.setItem(`${storageKeyPrefix}-input-${i}`, input.value);
  }
          checkAnswer(i, false);
        });
        console.log("✅ Test mode: answers filled and logging skipped.");
      }
    }
  });
});
</script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
  const testMode = urlParams.has('test');
  // Firebase config and initialization
  console.log("📦 Initializing Firebase...");
  const firebaseConfig = {
    apiKey: "AIzaSyAiqYse2jzA7l2r6VkwdmdBGs0LzwkXb2Y",
    authDomain: "cipherstick.firebaseapp.com",
    databaseURL: "https://cipherstick-default-rtdb.firebaseio.com",
    projectId: "cipherstick",
    storageBucket: "cipherstick.appspot.com",
    messagingSenderId: "827207706323",
    appId: "1:827207706323:web:a84d3c536b25e0e66c5626"
  };
  const app = firebase.initializeApp(firebaseConfig);
  console.log("✅ Firebase initialized.");

  // Wait for Firebase Auth state and ensure anonymous login before attempt/completion logging
  firebase.auth().onAuthStateChanged(function(user) {
    if (testMode) {
      console.warn("🚫 Test mode active — skipping attempt logging.");
      return;
    }
    if (user) {
      // User is signed in
      const uid = user.uid;
      window.authUID = uid;
      console.info("✅ Signed in anonymously:", uid);
      // Set timer to log attempt after 60 seconds on the page
      console.info("WAITING 60 SECONDS FOR ATTEMPT TO LOG")
      setTimeout(function() {
        // Use "abyss" as database record path
        const attemptRef = firebase.database().ref(`attempts/abyss/${uid}`);
        attemptRef.once('value').then(snap => {
          const data = snap.val();
          const now = Date.now();
          let lastTimestamp = null;
          if (data && data.timestamp) {
            // Firebase stores timestamp as number (ms since epoch) or as ServerValue.TIMESTAMP (number), or as ISO string if set that way.
            // Try to parse as number first, fallback to Date parse.
            if (typeof data.timestamp === "number") {
              lastTimestamp = data.timestamp;
            } else {
              // Try to parse as date string
              lastTimestamp = new Date(data.timestamp).getTime();
            }
          }

          console.log("🆕 Logging new attempt...");
          attemptRef.set({ timestamp: firebase.database.ServerValue.TIMESTAMP })
            .then(() => console.log("✅ Attempt logged"))
            .catch((err) => console.warn("❌ Failed to log attempt:", err));
       
        }).catch((err) => console.warn("❌ Error checking attempt timestamp:", err));
      }, 60000); // 60 seconds
    } else {
      // Not signed in, try to sign in anonymously
      firebase.auth().signInAnonymously().catch(error => {
        console.warn("❌ Auth error:", error.message);
      });
    }
  });
</script>
<script>
(function () {
  const BTN_W = '200px';
  const TITLE = 'CipherStick: ABYSS - THE ABYSS PROTOCOL';
  const MSG   = 'Try to solve this OSINT challenge!';
  const LINK  = location.href;

  function showNativeShare() {
    if (navigator.share && window.isSecureContext) {
      navigator.share({ title: TITLE, text: `${TITLE} — ${MSG}`, url: LINK })
        .catch(err => {
          if (err.name !== "AbortError") {
            console.warn('Share failed:', err);
            alert('Sharing not supported or failed.');
          }
        });
    } else {
      alert('Sharing not supported. Try on a phone or secure browser.');
    }
  }

  function closeFeedback() {
    const fm = document.getElementById('feedbackModal');
    if (fm) fm.style.display = 'none';
  }

  function ensureModal() {
    const html = `
      <div id="feedbackModal" class="name-input-modal" style="display:none;background:rgba(0,0,0,1);">
        <h2 style="margin-bottom:.75rem; color: white">Did you enjoy the challenge?</h2>
        <p style="margin-bottom:1rem; color: white">Share it with friends to spread the word! Or fill out the feedback form below to let us know what you thought.</p>
        <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:1.2rem;">
          <button onclick="showNativeShare()" style="width:${BTN_W};padding:.6rem 0;background:#b30000;color:#fff;border:none;border-radius:6px;
                  cursor:pointer;font-family:'Poppins',sans-serif;font-size:1rem;margin-bottom:.6rem;">
            🔗 Share
          </button>
          <a href="https://cipherstick.tech/#email" target="_blank"
             style="width:200px;padding:.6rem 0;background:#0d00ff;color:#fff;border:none;border-radius:6px;
                    cursor:pointer;font-family:'Poppins',sans-serif;font-weight:600;text-align:center;text-decoration:none;
                    margin-bottom:1.2rem;">
            📬 Sign Up for More Challenges
          </a>
          <a href="https://docs.google.com/forms/d/e/1FAIpQLSf6Au1H3w5a0FtKkBG1M3t9H8KDCL79WsZBvCVVZCOihMdFrQ/viewform?usp=sharing&ouid=114401666501663284939" target="_blank"
             style="width:200px;padding:.6rem 0;background:#00aa00;color:#fff;border:none;border-radius:6px;
                    cursor:pointer;font-family:'Poppins',sans-serif;font-weight:600;text-align:center;text-decoration:none;
                    margin-bottom:1.2rem;">
            📝 Give Feedback
          </a>
          <a href="https://buymeacoffee.com/midasthecoder" target="_blank"
             style="width:${BTN_W};padding:.6rem 0;background:#273FF1;color:#000;border:none;border-radius:6px;
                    cursor:pointer;font-family:'Poppins',sans-serif;font-weight:600;text-align:center;text-decoration:none;
                    margin-bottom:1.2rem;">
            ☕ Buy Me A Coffee
          </a>
          <button onclick="closeFeedback()" style="width:${BTN_W};padding:.6rem 0;background:#333;color:#ccc;border:none;border-radius:6px;
                  cursor:pointer;font-family:'Poppins',sans-serif;">
            Close
          </button>
        </div>
      </div>`;
    const existing = document.getElementById('feedbackModal');
    if (existing) existing.outerHTML = html;
    else document.body.insertAdjacentHTML('beforeend', html);
  }

  function patchDownload() {
    if (typeof window.downloadCertificate !== 'function') return;
    const original = window.downloadCertificate;
    window.downloadCertificate = function () {
      original.apply(this, arguments);
      setTimeout(() => {
        ensureModal();
        document.getElementById('feedbackModal').style.display = 'block';
      }, 300);
    };
  }

  ensureModal();
  patchDownload();

  window.showNativeShare = showNativeShare;
  window.closeFeedback = closeFeedback;
})();
</script>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="midasthecoder" data-description="Support me on Buy me a coffee!" data-message="" data-color="#273FF1" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
</script>
</script>
<!-- EmailJS integration (universal compatible) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  emailjs.init("vuIOVGmElOjK_aUJK");
</script>
</body>
</html>