<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Shortcut Maker + Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    body { max-width: 1000px; margin: 32px auto; padding: 0 16px; }
    h1 { margin-bottom: 8px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    textarea, input[type="text"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #bbb; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; background: black; color: white; cursor: pointer; }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .hint { color: #666; font-size: 13px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f0f0f0; font-size: 12px; margin-left: 8px; }
    .ok { color: #0a7f2e; }
    .bad { color: #b00020; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <h1>AI Shortcut Maker + Converter</h1>
  <p class="hint">Describe the Shortcut, let AI draft a Program (JSON) or DSL, convert to Shortcuts XML (.plist), then sign to a .shortcut.</p>

  <div class="card">
    <label for="shortcutName">Shortcut name</label>
    <input id="shortcutName" type="text" placeholder="E.g., 'Open my website'"/>

    <label for="prompt" style="margin-top:12px; display:block;">What should it do?</label>
    <textarea id="prompt" rows="5" placeholder="Example: Open https://cipherstick.tech in Safari."></textarea>

    <div class="row" style="margin-top:12px;">
      <button id="btnGenerate">1) AI: Plan & DSL</button>
      <span id="genStatus" class="pill">idle</span>
    </div>
    <div id="msgArea" class="hint mono" style="margin-top:8px; white-space:pre-wrap;"></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <strong>Program JSON (editable) ‚Äî or paste DSL</strong>
        <button id="btnCopyDSL" title="Copy Program">Copy Program</button>
      </div>
      <textarea id="dslBox" rows="16" spellcheck="false" class="mono"></textarea>
      <div class="row" style="margin-top:12px;">
        <button id="btnConvert">2) Convert ‚Üí .plist</button>
        <span id="convStatus" class="pill">waiting</span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <strong>.plist XML (editable)</strong>
        <button id="btnCopyPlist" title="Copy plist">Copy plist</button>
      </div>
      <textarea id="plistBox" rows="16" spellcheck="false" class="mono"></textarea>
      <div class="hint">Once it looks good, sign it:</div>
      <div class="row" style="margin-top:12px;">
        <button id="btnSign" disabled>3) Sign &amp; Download .shortcut</button>
        <span id="signStatus" class="pill">waiting</span>
      </div>
    </div>
  </div>

  <script>
  // üëá Your Worker that serves /generate and /sign (CORS must allow your site)
  const WORKER_ORIGIN = 'https://secrets.mwsaulsbury.workers.dev';

  const $ = (id) => document.getElementById(id);
  const nameBox   = $('shortcutName');
  const promptBox = $('prompt');
  const dslBox    = $('dslBox');
  const plistBox  = $('plistBox');

  const btnGenerate  = $('btnGenerate');
  const btnConvert   = $('btnConvert');
  const btnSign      = $('btnSign');
  const btnCopyDSL   = $('btnCopyDSL');
  const btnCopyPlist = $('btnCopyPlist');

  const genStatus  = $('genStatus');
  const convStatus = $('convStatus');
  const signStatus = $('signStatus');

  function setStatus(node, text, good=false, bad=false){
    node.textContent = text;
    node.classList.remove('ok','bad');
    if (good) node.classList.add('ok');
    if (bad)  node.classList.add('bad');
  }

  // ---------------- Helpers: JSON/DSL detection & coercion ----------------
  function stripBOM(s){ if (!s) return s; return s.replace(/^\uFEFF/, ""); }
  function stripFences(s){
    if (!s) return s;
    const m = s.match(/```(?:json|JSON)?\s*([\s\S]*?)\s*```/m);
    return m ? m[1] : s;
  }
  function sanitizeJSONText(raw){
    let s = String(raw ?? "");
    s = stripBOM(s).trim();
    s = stripFences(s);
    // remove trailing commas before } or ]
    s = s.replace(/,\s*([}\]])/g, "$1");
    // normalize smart quotes to straight
    s = s.replace(/[‚Äú‚Äù]/g, '"').replace(/[‚Äò‚Äô]/g, "'");
    return s.trim();
  }
  function parseMaybeJSON(raw){
    try {
      const cleaned = sanitizeJSONText(raw);
      if (!cleaned) return null;
      if (!(cleaned.startsWith('{') || cleaned.startsWith('['))) return null;
      return JSON.parse(cleaned);
    } catch { return null; }
  }
  function prettyStringify(v){
    try { return JSON.stringify(v, null, 2); } catch { return String(v); }
  }
  function showMessage(msg, isError=false){
    const el = document.getElementById('msgArea');
    if (!el) return;
    el.textContent = String(msg || "");
    el.style.color = isError ? '#b00020' : '#444';
  }

  // Accept anything and normalize as best as possible.
  // If it can't be normalized to a JSON program, return null and caller will use DSL/Universal path.
  function coerceProgram(value, fallbackName){
    let p = value;

    // If string, try JSON first
    if (typeof p === 'string') {
      const maybe = parseMaybeJSON(p);
      if (maybe !== null) p = maybe;
      else return null; // treat as DSL elsewhere
    }

    // Unwrap { program: {...} }
    if (p && typeof p === 'object' && p.program && typeof p.program === 'object') {
      p = { name: p.name || fallbackName, ...p.program };
    }

    // If actions array directly
    if (Array.isArray(p)) {
      p = { name: fallbackName, actions: p };
    }

    // If already {name?, actions?}
    if (p && typeof p === 'object') {
      if (!p.actions) p.actions = Array.isArray(p) ? p : [];
      if (!Array.isArray(p.actions)) p.actions = [];
      if (!p.name) p.name = fallbackName || 'My Shortcut';
      return p;
    }

    return null;
  }

  // Try multiple converter APIs. Prefer new universal wrapper if present.
  async function tryConverters({ name, inputRaw, programObj, dslText }){
    // 1) Universal tolerant path
    if (window.ConversionUniversal && typeof window.ConversionUniversal.toPlist === 'function') {
      try { return window.ConversionUniversal.toPlist(programObj ?? dslText ?? inputRaw, name); } catch(e){ /* fall through */ }
    }

    // 2) JSON-centric paths
    if (programObj) {
      const cj = window.ConversionJSON;
      if (cj && typeof cj.toPlist === 'function') {
        try { return cj.toPlist({ name, program: programObj }); } catch(e1) {
          try { return cj.toPlist(programObj, name); } catch(e2) {
            try { return cj.toPlist(programObj); } catch(e3) {}
          }
        }
      }
      const c = window.Conversion;
      if (c) {
        if (typeof c.toPlistFromJSON === 'function') { try { return c.toPlistFromJSON(programObj, name); } catch(e4){} }
        if (typeof c.toPlist === 'function')       { try { return c.toPlist(programObj, name); }       catch(e5){} }
      }
      const cdsl = window.ConversionDSL;
      if (cdsl && typeof cdsl.toPlistFromJSON === 'function') {
        try { return cdsl.toPlistFromJSON(programObj, name); } catch(e6){}
      }
    }

    // 3) DSL paths
    if (dslText) {
      const cdsl = window.ConversionDSL;
      if (cdsl && typeof cdsl.toPlist === 'function') {
        try { return cdsl.toPlist({ name, dsl: dslText }); } catch(e7){}
      }
    }

    // 4) Absolute last resort: emit a minimal comment-only plist so the flow never crashes
    if (window.ConversionUniversal && typeof window.ConversionUniversal.__makeCommentPlist === 'function') {
      return window.ConversionUniversal.__makeCommentPlist(name, 'Conversion failed. Input preview:\n' + String(inputRaw).slice(0,2000));
    }
    // fallback dead-simple minimal plist
    return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>WFWorkflowName</key><string>${(name||'My Shortcut')}</string>
  <key>WFWorkflowActions</key><array>
    <dict>
      <key>WFWorkflowActionIdentifier</key><string>is.workflow.actions.comment</string>
      <key>WFWorkflowActionParameters</key><dict>
        <key>WFCommentActionText</key><string>Conversion failed or unsupported input.</string>
      </dict>
    </dict>
  </array>
</dict>
</plist>`;
  }

  // ---------------- 1) AI plan/DSL ----------------
  btnGenerate.addEventListener('click', async () => {
    const prompt = (promptBox.value || '').trim();
    const name = (nameBox.value.trim() || 'My Shortcut').replace(/[^\w\s\-]/g,'').slice(0,60);
    if (!prompt) { alert('Please describe the shortcut.'); return; }

    setStatus(genStatus, 'generating‚Ä¶');
    btnGenerate.disabled = true;
    btnSign.disabled = true;

    try {
      const res = await fetch(`${WORKER_ORIGIN}/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, name })
      });
      const text = await res.text();
      let data = {};
      try { data = JSON.parse(text); } catch { throw new Error('Generate returned non-JSON'); }

      console.debug('‚Ü© /generate payload:', data);

      const programCandidate = data.programRaw ?? data.program ?? null;
      const dslCandidate     = data.program ? null : (data.dslRaw ?? data.dsl ?? null); // prefer program when present

      let programObj = null;
      if (programCandidate) {
        programObj = typeof programCandidate === 'object' ? programCandidate : parseMaybeJSON(programCandidate);
      }

      if (programObj) {
        if (!programObj.name) programObj.name = name;
        dslBox.value = prettyStringify(programObj);
        setStatus(genStatus, 'Program JSON ready ‚úî', true);
      } else if (dslCandidate) {
        dslBox.value = String(dslCandidate);
        setStatus(genStatus, 'DSL ready ‚úî', true);
      } else {
        dslBox.value = prettyStringify(data);
        setStatus(genStatus, 'response shown (no program/DSL)', true);
      }

      const planned = Array.isArray(data.planArray) ? data.planArray.length : 0;
      const used    = Array.isArray(data.usedFiles) ? data.usedFiles.length : 0;
      const catalog = Array.isArray(data.catalog)   ? data.catalog.length   : 0;
      showMessage(`Planned: ${planned} | Used: ${used} | Catalog: ${catalog}`);

    } catch (err) {
      console.error(err);
      setStatus(genStatus, 'error', false, true);
      showMessage(err.message || 'Generation failed', true);
      alert(err.message || 'Generation failed');
    } finally {
      btnGenerate.disabled = false;
    }
  });

  // ---------------- 2) Convert ----------------
  btnConvert.addEventListener('click', async () => {
    const name = (nameBox.value.trim() || 'My Shortcut').replace(/[^\w\s\-]/g,'').slice(0,60);
    const raw  = (dslBox.value || '').trim();
    if (!raw) { alert('Nothing to convert ‚Äî box is empty.'); return; }

    setStatus(convStatus, 'converting‚Ä¶');
    btnSign.disabled = true;

    try {
      // Decide lane: JSON-ish or DSL-ish or other
      const maybeJSON = parseMaybeJSON(raw);
      let programObj = null;
      let plistXML = '';

      if (maybeJSON !== null) {
        programObj = coerceProgram(maybeJSON, name); // may return null ‚Üí Universal handles it anyway
        plistXML = await tryConverters({ name, inputRaw: raw, programObj, dslText: null });
      } else {
        // Not JSON ‚Äî pass raw straight in (DSL or free text or even plist)
        plistXML = await tryConverters({ name, inputRaw: raw, programObj: null, dslText: raw });
      }

      if (!plistXML || typeof plistXML !== 'string') {
        throw new Error('Conversion produced empty output.');
      }

      plistBox.value = plistXML;
      btnSign.disabled = false;
      setStatus(convStatus, 'converted ‚úî', true);
      showMessage('Converted to .plist successfully.');
    } catch (err) {
      console.error(err);
      setStatus(convStatus, 'error', false, true);
      showMessage(err.message || 'Conversion failed', true);
      alert(err.message || 'Conversion failed');
    }
  });

  // ---------------- Copy helpers ----------------
  btnCopyDSL.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(dslBox.value || ''); btnCopyDSL.textContent = 'Copied!'; } catch {}
    setTimeout(() => btnCopyDSL.textContent = 'Copy Program', 800);
  });
  btnCopyPlist.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(plistBox.value || ''); btnCopyPlist.textContent = 'Copied!'; } catch {}
    setTimeout(() => btnCopyPlist.textContent = 'Copy plist', 800);
  });

  // ---------------- 3) Sign ----------------
  btnSign.addEventListener('click', async () => {
    const plist = (plistBox.value || '').trim();
    const name = (nameBox.value.trim() || 'My Shortcut').replace(/[^\w\s\-]/g,'').slice(0,60);
    if (!plist.startsWith('<?xml')) { alert('Your plist must be valid XML.'); return; }

    setStatus(signStatus, 'uploading‚Ä¶');
    btnSign.disabled = true;

    try {
      const file = new File([plist], `${name}.plist`, { type: "application/xml" });
      const form = new FormData();
      form.append('file', file);

      const res = await fetch(`${WORKER_ORIGIN}/sign`, { method: 'POST', body: form });
      const resText = await res.text();
      if (!res.ok) {
        showMessage(`Signer error ${res.status}: ${resText.slice(0,500)}`, true);
        throw new Error(`Sign failed: ${res.status}`);
      }
      const blob = new Blob([resText], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${name}.signed.shortcut`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      setStatus(signStatus, 'downloaded ‚úî', true);
      showMessage('Signed and downloaded .shortcut.');
    } catch (e) {
      console.error(e);
      setStatus(signStatus, 'error', false, true);
      showMessage(e.message || 'Signing failed', true);
      alert(e.message || 'Signing failed');
    } finally {
      btnSign.disabled = false;
    }
  });

  // Surface unhandled promise rejections to the UI
  window.addEventListener('unhandledrejection', (ev) => {
    try {
      const msg = ev?.reason?.message || String(ev.reason || ev);
      showMessage(`Unhandled error: ${msg}`, true);
      setStatus(convStatus, 'error', false, true);
    } catch {}
  });
</script>

  <!-- Conversion logic lives outside the page JS on purpose -->
  <script src="conversion.js"></script>
</body>
</html>