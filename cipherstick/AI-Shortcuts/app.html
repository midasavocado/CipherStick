<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux - AI Shortcut Generator</title>
    <meta name="description"
        content="Build Apple Shortcuts with AI. Flux turns natural language into powerful automation workflows.">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°Ô∏è</text></svg>">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/pages/app.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="conversions.js"></script>
</head>

<body class="mode-dark">
    <div class="app-container">
        <!-- Top Navigation Bar -->
        <nav class="top-bar" style="padding: 0 1.5rem;">
            <a href="index.html" class="logo-area" style="text-decoration: none; color: inherit;">
                <div class="logo-icon">F</div>
                <span>Flux</span>
            </a>
            <div class="nav-actions flex items-center gap-4">
                <button class="toolbar-btn primary" id="top-download-btn" onclick="openDownloadModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download
                </button>
                <div class="dropdown" id="profile-dropdown">
                    <button class="user-profile-btn" onclick="toggleProfileMenu()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </button>
                    <div class="dropdown-menu" id="profile-menu">
                        <div class="dropdown-item" onclick="window.location.href='settings.html'"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                </path>
                            </svg>Settings</div>
                        <div class="dropdown-item" onclick="window.location.href='pricing.html'"><svg width="16"
                                height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon
                                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                                </polygon>
                            </svg>Upgrade to Pro</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="toggleTheme()"><svg width="16" height="16"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>Toggle Theme</div>
                        <div class="dropdown-item" onclick="toggleAnimations()"><svg width="16" height="16"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 12l2 2 4-4"></path>
                            </svg><span id="animations-toggle-text">Disable Animations</span></div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="startTutorial()"><svg width="16" height="16"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>Replay Tutorial</div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main App Content -->
        <main class="app-main">
            <!-- Projects Dashboard View -->
            <div id="projects-view" class="projects-dashboard">
                <div class="dashboard-header">
                    <h1>Your Projects</h1>
                    <p>Build and manage your Apple Shortcuts</p>
                </div>
                <div id="projects-grid" class="projects-grid">
                    <div class="project-card new-project-card" onclick="createNewProject()">
                        <div class="plus-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </div>
                        <span>New Project</span>
                    </div>
                </div>
            </div>

            <!-- Workspace View -->
            <div id="workspace-view" class="workspace hidden">
                <!-- Chat Pane -->
                <aside class="chat-pane" id="chat-pane">
                    <div class="chat-header">
                        <button class="back-btn" onclick="showProjectsView()" title="Back to Projects">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M19 12H5"></path>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                        </button>
                        <span style="font-weight: 600; color: var(--heading-color);">Builder</span>
                    </div>

                    <!-- Pipeline Orbs (inline in chat) -->

                    <div class="messages-container" id="messages"></div>

                    <!-- Chat Input Area -->
                    <div class="chat-input-area">
                        <div class="plus-menu" id="plus-menu">
                            <div class="plus-menu-item" onclick="event.stopPropagation(); openForceActionModal();">
                                <div class="item-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                        <line x1="12" y1="8" x2="12" y2="16"></line>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                    </svg></div>
                                <div class="item-content">
                                    <div class="item-title">Force Action <span class="pro-badge">PRO</span></div>
                                    <div class="item-desc">Add a specific action to your shortcut</div>
                                </div>
                            </div>
                            <div class="plus-menu-item" id="discussion-mode-toggle"
                                onclick="event.stopPropagation(); toggleMode('discussion');">
                                <div class="item-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg></div>
                                <div class="item-content">
                                    <div class="item-title">Discussion Mode</div>
                                    <div class="item-desc">Chat without modifying shortcut</div>
                                </div>
                            </div>
                            <div class="plus-menu-item" id="thinking-mode-toggle"
                                onclick="event.stopPropagation(); toggleMode('thinking');">
                                <div class="item-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg></div>
                                <div class="item-content">
                                    <div class="item-title">Thinking Mode <span class="pro-badge">PRO</span></div>
                                    <div class="item-desc">Extended reasoning for complex tasks</div>
                                </div>
                            </div>
                        </div>
                        <!-- Forced Actions Display -->
                        <div class="forced-actions" id="forced-actions"></div>
                        <div class="chat-input-wrapper">
                            <button class="plus-menu-btn" id="plus-menu-btn"
                                onclick="event.stopPropagation(); togglePlusMenu();">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                            <textarea id="chat-input" class="chat-input" placeholder="Describe your shortcut..."
                                rows="1"></textarea>
                            <button class="send-btn" id="send-btn" onclick="handleSend()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                        <div class="chat-extras">
                            <div class="markdown-preview" id="markdown-preview" style="display:none;"></div>
                            <label class="instructions-label" for="custom-instructions-input">Custom instructions (included with every request)</label>
                            <textarea id="custom-instructions-input" class="instructions-input" rows="2" placeholder="e.g., Keep responses concise and focus on step-by-step edits."></textarea>
                        </div>
                    </div>
                    <div class="resize-handle" id="resize-handle"></div>
                </aside>

                <!-- Preview Pane -->
                <section class="preview-pane">
                    <div class="preview-toolbar">
                        <input type="text" id="project-name-input" class="project-name-input"
                            placeholder="Untitled Project" value="Untitled Project">
                        <div class="toolbar-actions">
                            <button class="toolbar-btn" id="add-action-btn" onclick="openForceActionModal()"
                                style="display: none;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Action
                            </button>
                            <button class="toolbar-btn" id="edit-btn" onclick="toggleEditMode()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                <span id="edit-btn-text">Edit</span>
                            </button>
                        </div>
                    </div>
                    <div class="preview-canvas" id="preview-canvas">
                        <div class="empty-state" id="empty-state">
                            <div class="icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                    <path d="M2 17l10 5 10-5"></path>
                                    <path d="M2 12l10 5 10-5"></path>
                                </svg></div>
                            <h3>Start Building</h3>
                            <p>Describe your shortcut in the chat and watch it come to life.</p>
                        </div>
                        <div id="actions-container" class="hidden"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Force Action Modal -->
    <div id="force-action-modal" class="modal-overlay">
        <div class="modal-card" style="max-width: 600px; max-height: 80vh;">
            <div class="modal-header">
                <h3>Force Action</h3>
                <button class="modal-close" onclick="closeForceActionModal()"><svg width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
            <input type="text" id="action-search" class="input-glass" placeholder="Search actions..."
                style="margin-bottom: 1rem; width: 100%;">
            <div id="actions-list"
                style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem;"></div>
        </div>
    </div>

    <!-- Download Modal -->
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Delete Action?</h3>
                <button class="modal-close" onclick="closeDeleteModal()"><svg width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this action? This cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn danger" onclick="confirmDeleteAction()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="download-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Download Shortcut</h3>
                <button class="modal-close" onclick="closeDownloadModal()"><svg width="16" height="16"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
            <div id="download-status"
                style="display: none; padding: 1rem; background: var(--surface-hover); border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                    <span id="download-status-text">Generating shortcut...</span>
                </div>
            </div>
            <div class="download-options">
                <div class="download-option disabled" id="download-private-option"
                    style="opacity: 0.5; cursor: not-allowed;">
                    <div class="option-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg></div>
                    <div class="option-content">
                        <h4>Download Private <span class="pro-badge">PRO</span></h4>
                        <p>Download for personal use. Chat history stays private.</p>
                    </div>
                </div>
                <div class="download-option" onclick="executeDownload('publish')">
                    <div class="option-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path
                                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                            </path>
                        </svg></div>
                    <div class="option-content">
                        <h4>Download &amp; Publish</h4>
                        <p>Share with the community. Shortcut only, no chat.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variable Context Menu -->
    <div id="variable-context-menu" class="context-menu">
        <div class="context-menu-header">Insert Variable</div>
        <div class="context-menu-item" onclick="insertVariable('Shortcut Input')">üì• Shortcut Input</div>
        <div class="context-menu-item" onclick="insertVariable('Clipboard')">üìã Clipboard</div>
        <div class="context-menu-item" onclick="insertVariable('Current Date')">üìÖ Current Date</div>
        <div class="context-menu-item" onclick="insertVariable('Device Name')">üì± Device Name</div>
        <div class="context-menu-item" onclick="insertVariable('Ask Each Time')">‚ùì Ask Each Time</div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-spotlight" id="tutorial-spotlight"></div>
        <div class="tutorial-popup" id="tutorial-popup">
            <div class="tutorial-step-indicator" id="tutorial-indicator"></div>
            <h3 id="tutorial-title">Welcome to Flux!</h3>
            <p id="tutorial-text">Let's take a quick tour of how to build shortcuts with AI.</p>
            <div class="tutorial-actions">
                <button class="tutorial-skip" onclick="skipTutorial()">Skip Tutorial</button>
                <button class="tutorial-next" id="tutorial-next" onclick="nextTutorialStep()">Next</button>
            </div>
        </div>
    </div>

    <script src="theme.js"></script>
    <script src="flux-ui.js"></script>
    <script>
        // ============ Configuration ============
        const API_BASE = 'https://secrets.mwsaulsbury.workers.dev';
        const IS_PRO_USER = false; // Set to true for pro users

        // ============ State ============
        let currentProject = null;
        let projects = JSON.parse(localStorage.getItem('flux_projects')) || [];
        let chatMode = 'standard'; // 'standard', 'discussion', 'thinking'
        let availableTemplates = [];
        let currentActions = [];
        let currentProgramObj = null;
        let isGenerating = false;
        let editMode = false;
        let forcedActions = [];
        let animationsEnabled = localStorage.getItem('flux_animations') !== 'disabled';
        let contextMenuTarget = null;
        let tutorialStep = 0;
        let hasCompletedTutorial = localStorage.getItem('flux_tutorial_done') === 'true';
        let customInstructions = localStorage.getItem('flux_custom_instructions') || '';

        // ============ Init ============
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            initTheme();
            initResizeHandle();
            loadTemplates();
            initEventListeners();
            hydrateCustomInstructions();
        });

        function initApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            const initialPrompt = urlParams.get('prompt');
            if (projectId) {
                loadProject(projectId);
            } else if (initialPrompt) {
                createNewProject(initialPrompt);
            } else {
                showProjectsView();
            }
        }

        function initEventListeners() {
            document.getElementById('chat-input')?.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            document.getElementById('chat-input')?.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            document.getElementById('project-name-input')?.addEventListener('blur', function () {
                if (currentProject && this.value.trim()) {
                    currentProject.name = this.value.trim();
                    saveProjects();
                }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#plus-menu') && !e.target.closest('#plus-menu-btn')) {
                    document.getElementById('plus-menu')?.classList.remove('active');
                    document.getElementById('plus-menu-btn')?.classList.remove('active');
                }
                if (!e.target.closest('#profile-dropdown')) {
                    document.getElementById('profile-menu')?.classList.remove('active');
                }
            });
            const instructionsInput = document.getElementById('custom-instructions-input');
            instructionsInput?.addEventListener('input', (e) => {
                customInstructions = e.target.value;
                localStorage.setItem('flux_custom_instructions', customInstructions);
                updateMarkdownPreview();
            });
            document.getElementById('chat-input')?.addEventListener('input', updateMarkdownPreview);
        }

        function hydrateCustomInstructions() {
            const instructionsInput = document.getElementById('custom-instructions-input');
            if (instructionsInput) {
                instructionsInput.value = customInstructions;
            }
        }

        function initTheme() {
            if (!localStorage.getItem('flux_theme')) {
                document.body.classList.add('mode-dark');
                localStorage.setItem('flux_theme', 'dark');
            } else {
                const theme = localStorage.getItem('flux_theme');
                document.body.classList.toggle('mode-dark', theme === 'dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            document.body.classList.toggle('mode-dark');
            localStorage.setItem('flux_theme', document.body.classList.contains('mode-dark') ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            const isDark = document.body.classList.contains('mode-dark');
            if (sunIcon) sunIcon.style.display = isDark ? 'block' : 'none';
            if (moonIcon) moonIcon.style.display = isDark ? 'none' : 'block';
        }

        // ============ Views ============
        function showProjectsView() {
            document.getElementById('projects-view').classList.remove('hidden');
            document.getElementById('workspace-view').classList.add('hidden');
            window.history.replaceState({}, '', 'app.html');
            renderProjectsGrid();
        }

        function showWorkspaceView() {
            document.getElementById('projects-view').classList.add('hidden');
            document.getElementById('workspace-view').classList.remove('hidden');
        }

        // ============ Projects ============
        function renderProjectsGrid() {
            const grid = document.getElementById('projects-grid');
            if (!grid) return;
            const newCard = grid.querySelector('.new-project-card');
            grid.innerHTML = '';
            if (newCard) grid.appendChild(newCard);

            projects.forEach(p => {
                const card = document.createElement('div');
                card.className = 'project-card';
                card.onclick = () => loadProject(p.id);
                const date = new Date(p.updated).toLocaleDateString();
                const actionCount = p.actions ? p.actions.length : 0;
                card.innerHTML = `
                    <h3>${escapeHtml(p.name)}</h3>
                    <div class="project-meta"><span>${date}</span><span>${actionCount} actions</span></div>
                    <div class="project-actions">
                        <button class="node-action-btn delete" onclick="event.stopPropagation(); deleteProject('${p.id}')" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function createNewProject(initialPrompt = null) {
            const id = 'proj_' + Date.now();
            const newProject = {
                id,
                name: 'New Shortcut',
                created: Date.now(),
                updated: Date.now(),
                history: [],
                actions: [],
                programObj: null
            };
            projects.unshift(newProject);
            saveProjects();
            loadProject(id);
            if (initialPrompt) {
                setTimeout(() => {
                    document.getElementById('chat-input').value = initialPrompt;
                    handleSend();
                }, 300);
            }
        }

        function loadProject(id) {
            currentProject = projects.find(p => p.id === id);
            if (!currentProject) { showProjectsView(); return; }
            currentActions = currentProject.actions || [];
            currentProgramObj = currentProject.programObj || null;
            showWorkspaceView();
            document.getElementById('project-name-input').value = currentProject.name;
            window.history.replaceState({}, '', `app.html?id=${id}`);
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML = '';
            // No welcome message - show empty state instead
            if (currentProject.history.length > 0) {
                currentProject.history.forEach(msg => addMessageToUI(msg.content, msg.role));
            }
            renderActions();
        }

        function saveProjects() {
            localStorage.setItem('flux_projects', JSON.stringify(projects));
        }

        function deleteProject(id) {
            if (event) event.stopPropagation();
            showDeleteModal('project', id);
        }

        // ============ Chat ============
        async function handleSend() {
            if (isGenerating) return;
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addMessageToUI(text, 'user');
            input.value = '';
            input.style.height = 'auto';

            if (currentProject) {
                currentProject.history.push({ role: 'user', content: text });
                saveProjects();
            }

            await callGenerateAPI(text);
        }

        function addMessageToUI(text, role) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            const avatar = role === 'user'
                ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'
                : 'F';
            div.innerHTML = `<div class="message-avatar">${avatar}</div><div class="message-bubble">${formatMessage(text)}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function formatMessage(text) {
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'typing-indicator';
            div.innerHTML = `<div class="message-avatar">F</div><div class="message-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }

        function updateMarkdownPreview() {
            const chatVal = document.getElementById('chat-input')?.value || '';
            const instructionsVal = document.getElementById('custom-instructions-input')?.value || '';
            const preview = document.getElementById('markdown-preview');
            if (!preview) return;
            const combined = [chatVal, instructionsVal ? `\n\nInstructions: ${instructionsVal}` : ''].join('').trim();
            if (!combined) {
                preview.style.display = 'none';
                preview.innerHTML = '';
                return;
            }
            preview.style.display = 'block';
            preview.innerHTML = formatMessage(combined);
        }

        // ============ AI API ============
        async function callGenerateAPI(userPrompt) {
            isGenerating = true;
            showPipelineOrbs();
            showTypingIndicator();

            try {
                const plan = (localStorage.getItem('flux_plan') || 'free') === 'paid' ? 'paid' : 'free';
                const model = plan === 'paid' ? 'grok-4.1-fast' : 'openai/gpt-oss-120b:free';
                console.log(`[Flux] Using model: ${model} (plan: ${plan})`);

                const isFollowUp = currentProject.history.filter(m => m.role === 'user').length > 1;
                const body = {
                    name: currentProject.name,
                    prompt: userPrompt,
                    basePrompt: isFollowUp ? currentProject.history[0]?.content : userPrompt,
                    followPrompt: isFollowUp ? userPrompt : undefined,
                    history: currentProject.history.slice(-10),
                    mode: chatMode === 'thinking' ? 'think' : 'plan',
                    model,
                    plan,
                    instructions: customInstructions || '',
                    style: 'concise'
                };
                if (currentProgramObj) {
                    body.programPreview = JSON.stringify(currentProgramObj);
                }

                const response = await fetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok || !response.body) {
                    const errText = await response.text().catch(() => '');
                    throw new Error(`Generation failed (${response.status}) ${errText.slice(0, 120)}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.trim() || !line.trim().startsWith('{')) continue;
                        try {
                            const packet = JSON.parse(line);
                            handleStreamPacket(packet);
                            if (packet.type === 'final' || packet.type === 'error') {
                                finalData = packet;
                            }
                        } catch (e) { console.warn('Parse error:', e); }
                    }
                }

                removeTypingIndicator();
                removePipelineOrbs();

                if (finalData) {
                    handleFinalResponse(finalData);
                }
            } catch (err) {
                console.error('API Error:', err);
                removeTypingIndicator();
                removePipelineOrbs();
                addMessageToUI('‚ö†Ô∏è Failed to connect to the AI service. Please try again.', 'assistant');
            }

            isGenerating = false;
        }

        function handleStreamPacket(packet) {
            if (packet.type === 'progress') {
                updatePipelineOrb(packet.step, packet.status);
            }
        }

        function updatePipelineStep(step, status) {
            const stepEl = document.getElementById(`step-${step}`);
            if (!stepEl) return;
            stepEl.classList.remove('active', 'completed');
            if (status === 'started') stepEl.classList.add('active');
            else if (status === 'completed') stepEl.classList.add('completed');
        }

        function resetPipelineSteps() {
            ['plan', 'catalog', 'build', 'summarize'].forEach(s => {
                const el = document.getElementById(`step-${s}`);
                if (el) el.classList.remove('active', 'completed');
                const orb = document.getElementById(`orb-${s}`);
                orb?.classList.remove('active', 'completed');
            });
            const statusDiv = document.getElementById('pipeline-status');
            if (statusDiv) statusDiv.textContent = formatPipelineStatus();
        }

        function formatPipelineStatus(step, status) {
            const actionNames = currentActions.map(a => a.title || a.action).filter(Boolean);
            const actionText = actionNames.length ? actionNames.join(', ') : 'None selected';
            const stageText = step ? `${step} ${status || ''}`.trim() : 'idle';
            return `Selected actions: ${actionText} | Stage: ${stageText}`;
        }

        function handleFinalResponse(data) {
            if (!data.ok) {
                addMessageToUI(`‚ö†Ô∏è ${data.message || 'An error occurred'}`, 'assistant');
                return;
            }
            ['plan', 'catalog', 'build', 'summarize'].forEach(s => updatePipelineOrb(s, 'completed'));

            // Update project name from AI
            if (data.finalName && currentProject) {
                currentProject.name = data.finalName;
                document.getElementById('project-name-input').value = data.finalName;
            }

            // Store program object
            if (data.program) {
                currentProgramObj = data.program;
                if (currentProject) currentProject.programObj = currentProgramObj;

                // Extract actions from program
                if (Array.isArray(data.program.actions)) {
                    currentActions = data.program.actions.map((act, i) => ({
                        id: Date.now() + i,
                        action: act.action || 'Unknown',
                        title: act.action || 'Action',
                        params: act.params || {}
                    }));
                    if (currentProject) currentProject.actions = currentActions;
                }
            }

            // Add AI response to chat
            if (data.answer) {
                addMessageToUI(data.answer, 'assistant');
                if (currentProject) {
                    currentProject.history.push({ role: 'assistant', content: data.answer });
                }
            }

            saveProjects();
            // Animate all actions from AI response
            renderActions(true);
        }

        // ============ Actions Preview ============
        function renderActions(animateIds = null) {
            const container = document.getElementById('actions-container');
            const emptyState = document.getElementById('empty-state');

            if (currentActions.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            container.innerHTML = '';

            currentActions.forEach((action, index) => {
                let shouldAnimate = false;
                if (animateIds === true) shouldAnimate = true;
                else if (Array.isArray(animateIds) && animateIds.includes(action.id)) shouldAnimate = true;

                const node = createActionNode(action, index, shouldAnimate);
                container.appendChild(node);
                if (index < currentActions.length - 1) {
                    const line = document.createElement('div');
                    line.className = 'connection-line';
                    container.appendChild(line);
                }
            });
            initDragAndDrop();
        }

        function createActionNode(action, index, shouldAnimate = false) {
            const node = document.createElement('div');
            node.className = 'action-node';
            if (shouldAnimate && animationsEnabled) {
                node.classList.add('settling');
                node.style.animationDelay = `${index * 0.1}s`;
            }
            node.draggable = editMode;
            node.dataset.id = action.id;
            node.dataset.index = index;
            node.dataset.type = action.action;

            let paramsHtml = '';
            // Show params if in edit mode OR if they have a value (not empty/default)
            if (action.params && Object.keys(action.params).length > 0) {
                let hasVisibleParams = false;
                let innerHtml = '<div class="node-params">';
                for (const [key, value] of Object.entries(action.params)) {
                    // In view mode, only show if value is present and not a placeholder
                    const strVal = String(value);
                    const isPlaceholder = strVal.startsWith('{{') && strVal.endsWith('}}');
                    if (editMode || (strVal && !isPlaceholder)) {
                        hasVisibleParams = true;
                        const inputHtml = getInputForType(action.id, key, value, !editMode);
                        innerHtml += `
                            <div class="node-param">
                                <span class="param-label">${escapeHtml(key)}</span>
                                ${inputHtml}
                            </div>
                        `;
                    }
                }
                innerHtml += '</div>';
                if (hasVisibleParams) {
                    paramsHtml = innerHtml;
                }
            }

            const actionsHtml = editMode ? `
                <div class="node-actions">
                    <button class="node-action-btn" onclick="duplicateAction(${action.id})" title="Duplicate"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                    <button class="node-action-btn delete" onclick="deleteAction(${action.id})" title="Delete"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>
            ` : '';

            const dragHandle = editMode ? '<div class="node-drag-handle"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="6" r="2"></circle><circle cx="15" cy="6" r="2"></circle><circle cx="9" cy="12" r="2"></circle><circle cx="15" cy="12" r="2"></circle><circle cx="9" cy="18" r="2"></circle><circle cx="15" cy="18" r="2"></circle></svg></div>' : '';

            node.innerHTML = `
                ${dragHandle}
                <div class="node-icon">${getActionIcon(action.action)}</div>
                <div class="node-content">
                    <div class="node-header">
                        <span class="node-title">${escapeHtml(action.title || action.action)}</span>
                        ${actionsHtml}
                    </div>
                    ${paramsHtml}
                </div>
            `;
            return node;
        }

        function getInputForType(actionId, key, value, readonly = false) {
            const strValue = String(value);
            const lowerVal = strValue.toLowerCase();
            const disabledAttr = readonly ? 'disabled' : '';

            // Boolean detection
            if (lowerVal === 'true' || lowerVal === 'false' || strValue === '{{BOOLEAN}}') {
                const checked = lowerVal === 'true' ? 'checked' : '';
                return `<input type="checkbox" class="param-checkbox" data-action-id="${actionId}" data-param="${escapeHtml(key)}" ${checked} ${disabledAttr} onchange="updateActionParam(${actionId}, '${escapeHtml(key)}', this.checked)">`;
            }

            // Number detection
            if (!isNaN(strValue) && strValue !== '') {
                return `<input type="number" class="param-value param-number" data-action-id="${actionId}" data-param="${escapeHtml(key)}" value="${escapeHtml(strValue)}" ${disabledAttr} onchange="updateActionParam(${actionId}, '${escapeHtml(key)}', this.value)">`;
            }

            // Dropdown for options like {{option1/option2/option3}}
            const optionsMatch = strValue.match(/^\{\{([^}]+\/[^}]+)\}\}$/);
            if (optionsMatch) {
                const options = optionsMatch[1].split('/');
                const optionsHtml = options.map(opt => `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`).join('');
                return `<select class="param-value param-select" data-action-id="${actionId}" data-param="${escapeHtml(key)}" ${disabledAttr} onchange="updateActionParam(${actionId}, '${escapeHtml(key)}', this.value)">${optionsHtml}</select>`;
            }

            // Default text input
            const contextMenuAttr = readonly ? '' : 'oncontextmenu="showVariableMenu(event, this)"';
            return `<input type="text" class="param-value" data-action-id="${actionId}" data-param="${escapeHtml(key)}" value="${escapeHtml(strValue)}" ${disabledAttr} onchange="updateActionParam(${actionId}, '${escapeHtml(key)}', this.value)" ${contextMenuAttr}>`;
        }

        function formatParamValue(value) {
            if (typeof value === 'string') {
                // Highlight variables like {{input}} or {{Clipboard}}
                return value.replace(/\{\{([^}]+)\}\}/g, '<span class="variable-tag">$1</span>');
            }
            return String(value);
        }

        function getActionIcon(actionType) {
            const icons = {
                'If': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>',
                'Repeat': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>',
                'Ask.ForInput': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
                'Notification': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>',
                'Openurl': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>',
                'Showresult': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>',
                'Getclipboard': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>',
                'Text': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',
                'Variable.Set': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>'
            };
            return icons[actionType] || '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"></rect></svg>';
        }

        function updateActionParam(actionId, paramKey, value) {
            const action = currentActions.find(a => a.id === actionId);
            if (action) {
                action.params[paramKey] = value;
                if (currentProject) {
                    currentProject.actions = currentActions;
                    saveProjects();
                }
            }
        }

        let deleteTargetId = null;
        let deleteTargetType = null; // 'action' or 'project'

        function showDeleteModal(type, id) {
            deleteTargetType = type;
            deleteTargetId = id;

            const titleEl = document.querySelector('#delete-modal h3');
            const textEl = document.querySelector('#delete-modal p');

            if (type === 'project') {
                titleEl.textContent = 'Delete Project?';
                textEl.textContent = 'Are you sure you want to delete this project? This cannot be undone.';
            } else {
                titleEl.textContent = 'Delete Action?';
                textEl.textContent = 'Are you sure you want to delete this action? This cannot be undone.';
            }

            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            deleteTargetId = null;
            deleteTargetType = null;
        }

        function confirmDeleteAction() {
            if (!deleteTargetId) return;

            if (deleteTargetType === 'project') {
                projects = projects.filter(p => p.id !== deleteTargetId);
                saveProjects();
                if (currentProject && currentProject.id === deleteTargetId) {
                    currentProject = null;
                    currentActions = [];
                    showProjectsView();
                } else {
                    renderProjectsGrid();
                }
            } else if (deleteTargetType === 'action') {
                currentActions = currentActions.filter(a => a.id !== deleteTargetId);
                if (currentProject) {
                    currentProject.actions = currentActions;
                    saveProjects();
                }
                renderActions();
            }
            closeDeleteModal();
        }

        function deleteAction(actionId) {
            showDeleteModal('action', actionId);
        }

        function duplicateAction(actionId) {
            const action = currentActions.find(a => a.id === actionId);
            if (action) {
                const newAction = { ...action, id: Date.now(), params: { ...action.params } };
                const index = currentActions.findIndex(a => a.id === actionId);
                currentActions.splice(index + 1, 0, newAction);
                if (currentProject) {
                    currentProject.actions = currentActions;
                    saveProjects();
                }
                renderActions([newAction.id]);
            }
        }

        // ============ Drag and Drop ============
        function initDragAndDrop() {
            const container = document.getElementById('actions-container');
            const nodes = container.querySelectorAll('.action-node');
            let draggedEl = null;

            nodes.forEach(node => {
                node.addEventListener('dragstart', (e) => {
                    draggedEl = node;
                    node.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                node.addEventListener('dragend', () => {
                    if (draggedEl) { draggedEl.classList.remove('dragging'); draggedEl = null; }
                });
                node.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedEl || draggedEl === node) return;
                    const rect = node.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) container.insertBefore(draggedEl, node);
                    else container.insertBefore(draggedEl, node.nextSibling);
                });
                node.addEventListener('drop', (e) => { e.preventDefault(); updateActionsOrder(); });
            });
        }

        function updateActionsOrder() {
            const container = document.getElementById('actions-container');
            const nodes = container.querySelectorAll('.action-node');
            const newOrder = [];
            nodes.forEach(node => {
                const id = parseInt(node.dataset.id);
                const action = currentActions.find(a => a.id === id);
                if (action) newOrder.push(action);
            });
            currentActions = newOrder;
            if (currentProject) { currentProject.actions = currentActions; saveProjects(); }
            renderActions();
        }

        // ============ Menus ============
        function togglePlusMenu() {
            const menu = document.getElementById('plus-menu');
            const btn = document.getElementById('plus-menu-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function toggleProfileMenu() {
            document.getElementById('profile-menu')?.classList.toggle('active');
        }

        function setChatMode(mode) {
            chatMode = mode;
            document.getElementById('plus-menu')?.classList.remove('active');
            document.getElementById('plus-menu-btn')?.classList.remove('active');
            const input = document.getElementById('chat-input');
            if (mode === 'thinking') input.placeholder = 'üß† Thinking mode active...';
            else if (mode === 'discussion') input.placeholder = 'üí¨ Discussion mode...';
            else input.placeholder = 'Describe your shortcut...';
        }

        // ============ Force Action Modal ============
        async function loadTemplates() {
            try {
                const response = await fetch('Templates/index.json');
                const files = await response.json();
                availableTemplates = files.map(f => typeof f === 'string' ? { file: f, action: f.replace('.json', '') } : { file: f.file, action: f.file.replace('.json', '') });
            } catch (e) { console.error('Failed to load templates:', e); }
        }

        function openForceActionModal() {
            document.getElementById('plus-menu')?.classList.remove('active');
            document.getElementById('plus-menu-btn')?.classList.remove('active');
            document.getElementById('force-action-modal').classList.add('active');
            renderActionsList();
            const searchInput = document.getElementById('action-search');
            searchInput.value = '';
            searchInput.focus();
            searchInput.oninput = () => renderActionsList(searchInput.value);
        }

        function closeForceActionModal() {
            document.getElementById('force-action-modal').classList.remove('active');
        }

        function renderActionsList(filter = '') {
            const list = document.getElementById('actions-list');
            list.innerHTML = '';
            const term = filter.toLowerCase();
            const filtered = availableTemplates.filter(t => t.action.toLowerCase().includes(term));
            filtered.forEach(t => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.style.cssText = 'padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;';
                item.innerHTML = `<div class="node-icon" style="width:32px;height:32px;">${getActionIcon(t.action)}</div><span>${escapeHtml(t.action)}</span>`;
                item.onclick = () => {
                    if (editMode) {
                        addActionDirectly(t);
                    } else {
                        addForcedAction(t);
                    }
                };
                list.appendChild(item);
            });
        }

        async function addActionDirectly(template) {
            closeForceActionModal();
            try {
                const response = await fetch(`Templates/${template.file}`);
                let text = await response.text();
                // Remove comments (lines starting with # or //, or inline comments)
                text = text.split('\n').map(line => {
                    // Simple check: if line has # or //, check if it's inside quotes
                    let inString = false;
                    let result = '';
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && (i === 0 || line[i - 1] !== '\\')) {
                            inString = !inString;
                        }
                        if (!inString && (char === '#' || (char === '/' && line[i + 1] === '/'))) {
                            // Found comment start outside string
                            break;
                        }
                        result += char;
                    }
                    return result;
                }).join('\n');
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (jsonErr) {
                    console.warn('JSON parse error, using fallback:', jsonErr);
                    data = { action: template.action, params: {} };
                }
                const newAction = { id: Date.now(), action: data.action || template.action, title: data.action || template.action, params: data.params || {} };
                currentActions.push(newAction);
                if (currentProject) { currentProject.actions = currentActions; saveProjects(); }
                renderActions([newAction.id]);
            } catch (e) { console.error('Failed to load action template:', e); }
        }

        // ============ Download ============
        function openDownloadModal() {
            document.getElementById('download-modal').classList.add('active');
        }

        function closeDownloadModal() {
            document.getElementById('download-modal').classList.remove('active');
            document.getElementById('download-status').style.display = 'none';
        }

        async function executeDownload(type) {
            if (currentActions.length === 0) {
                alert('No actions to download. Build your shortcut first!');
                return;
            }

            const statusEl = document.getElementById('download-status');
            const statusText = document.getElementById('download-status-text');
            statusEl.style.display = 'block';
            statusText.textContent = 'Converting to shortcut format...';

            try {
                // Build program object
                const programObj = {
                    name: currentProject?.name || 'My Shortcut',
                    actions: currentActions.map(a => ({ action: a.action, params: a.params }))
                };

                // Convert to plist
                statusText.textContent = 'Generating plist...';
                const convertRes = await fetch(`${API_BASE}/convert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(programObj)
                });
                const convertData = await convertRes.json();
                if (!convertData.ok) throw new Error(convertData.message || 'Conversion failed');

                // Sign the shortcut
                statusText.textContent = 'Signing shortcut...';
                const plistBlob = new Blob([convertData.plist], { type: 'application/xml' });
                const signRes = await fetch(`${API_BASE}/sign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    body: plistBlob
                });

                if (!signRes.ok) {
                    throw new Error('Signing failed');
                }

                // Download
                statusText.textContent = 'Downloading...';
                const blob = await signRes.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${programObj.name.replace(/[^a-z0-9]/gi, '_')}.shortcut`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                closeDownloadModal();
            } catch (err) {
                console.error('Download error:', err);
                statusText.textContent = '‚ö†Ô∏è ' + (err.message || 'Download failed');
                if ((err.message || '').toLowerCase().includes('sign')) {
                    showSigningFallbackModal();
                }
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
            }
        }

        function showSigningFallbackModal() {
            const modalHtml = `
                <div id="signing-fallback" class="flux-modal-overlay active">
                    <div class="flux-modal-card">
                        <h3>We can't sign that right now</h3>
                        <p>Our signer is temporarily unavailable. You can still generate the shortcut later.</p>
                        <label style="display:flex; align-items:center; gap:0.5rem; margin: 1rem 0;">
                            <input type="checkbox" id="signing-email-optin">
                            <span>Email me when signing is available again</span>
                        </label>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-secondary" onclick="document.getElementById('signing-fallback').remove()">Close</button>
                            <button class="btn btn-primary" onclick="ackSigningFallback()">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function ackSigningFallback() {
            const optIn = document.getElementById('signing-email-optin')?.checked;
            console.log(`[Flux] Signing unavailable. Notify opt-in: ${optIn ? 'yes' : 'no'}`);
            document.getElementById('signing-fallback')?.remove();
        }

        // ============ Resize Handle ============
        function initResizeHandle() {
            const chatPane = document.getElementById('chat-pane');
            const handle = document.getElementById('resize-handle');
            if (!chatPane || !handle) return;
            let isResizing = false;
            handle.addEventListener('mousedown', () => { isResizing = true; handle.classList.add('active'); document.body.style.cursor = 'col-resize'; });
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                let newWidth = e.clientX;
                if (newWidth < 320) newWidth = 320;
                if (newWidth > 600) newWidth = 600;
                chatPane.style.width = `${newWidth}px`;
            });
            document.addEventListener('mouseup', () => { isResizing = false; handle.classList.remove('active'); document.body.style.cursor = ''; });
        }

        // ============ Edit Mode ============
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('edit-btn');
            const btnText = document.getElementById('edit-btn-text');
            const addBtn = document.getElementById('add-action-btn');
            if (editMode) {
                btn.classList.add('primary');
                btnText.textContent = 'Done';
                document.getElementById('actions-container')?.classList.add('edit-mode');
                if (addBtn) addBtn.style.display = 'flex';
            } else {
                btn.classList.remove('primary');
                btnText.textContent = 'Edit';
                document.getElementById('actions-container')?.classList.remove('edit-mode');
                if (addBtn) addBtn.style.display = 'none';
            }
            renderActions();
        }

        // ============ Pipeline Orbs (in chat) ============
        function showPipelineOrbs() {
            const container = document.getElementById('messages');
            const existing = document.getElementById('pipeline-orbs');
            if (existing) existing.remove();

            const orbsDiv = document.createElement('div');
            orbsDiv.id = 'pipeline-orbs';
            orbsDiv.className = 'pipeline-orbs';
            orbsDiv.innerHTML = `
                <div class="orb" id="orb-plan"><span>Planning</span></div>
                <div class="orb-line"></div>
                <div class="orb" id="orb-catalog"><span>Searching</span></div>
                <div class="orb-line"></div>
                <div class="orb" id="orb-build"><span>Building</span></div>
                <div class="orb-line"></div>
                <div class="orb" id="orb-summarize"><span>Finalizing</span></div>
            `;
            container.appendChild(orbsDiv);
            const status = document.createElement('div');
            status.id = 'pipeline-status';
            status.className = 'pipeline-status';
            status.textContent = formatPipelineStatus();
            container.appendChild(status);
            container.scrollTop = container.scrollHeight;
            resetPipelineSteps();
            updatePipelineOrb('plan', 'started');
        }

        function updatePipelineOrb(step, status) {
            const orb = document.getElementById(`orb-${step}`);
            if (!orb) return;
            orb.classList.remove('active', 'completed');
            if (status === 'started') orb.classList.add('active');
            else if (status === 'completed') orb.classList.add('completed');
            const statusDiv = document.getElementById('pipeline-status');
            if (statusDiv) statusDiv.textContent = formatPipelineStatus(step, status);
        }

        function removePipelineOrbs() {
            document.getElementById('pipeline-orbs')?.remove();
        }

        // ============ Forced Actions ============
        function addForcedAction(template) {
            closeForceActionModal();
            if (forcedActions.find(a => a.action === template.action)) return; // Already forced
            forcedActions.push({ action: template.action, file: template.file });
            renderForcedActions();
            addMessageToUI(`üéØ Will use **${template.action}** in next response`, 'assistant');
        }

        function removeForcedAction(action) {
            forcedActions = forcedActions.filter(a => a.action !== action);
            renderForcedActions();
        }

        function renderForcedActions() {
            const container = document.getElementById('forced-actions');
            if (!container) return;
            if (forcedActions.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }
            container.style.display = 'flex';
            container.innerHTML = forcedActions.map(a => `
                <div class="forced-action-pill">
                    <span>${escapeHtml(a.action)}</span>
                    <button onclick="removeForcedAction('${escapeHtml(a.action)}')">&times;</button>
                </div>
            `).join('');
        }

        // ============ Mode Toggle (in plus menu) ============
        function toggleMode(mode) {
            if (chatMode === mode) {
                chatMode = 'standard';
            } else {
                chatMode = mode;
            }
            updateModeIndicators();
            // Don't close menu - let user see the state change
        }

        function updateModeIndicators() {
            const discussionToggle = document.getElementById('discussion-mode-toggle');
            const thinkingToggle = document.getElementById('thinking-mode-toggle');

            discussionToggle?.classList.toggle('active', chatMode === 'discussion');
            thinkingToggle?.classList.toggle('active', chatMode === 'thinking');
        }

        // ============ Animations Toggle ============
        function toggleAnimations() {
            animationsEnabled = !animationsEnabled;
            localStorage.setItem('flux_animations', animationsEnabled ? 'enabled' : 'disabled');
            document.body.classList.toggle('no-animations', !animationsEnabled);
            const text = document.getElementById('animations-toggle-text');
            if (text) text.textContent = animationsEnabled ? 'Disable Animations' : 'Enable Animations';
            document.getElementById('profile-menu')?.classList.remove('active');
        }

        function initAnimations() {
            if (!animationsEnabled) {
                document.body.classList.add('no-animations');
                const text = document.getElementById('animations-toggle-text');
                if (text) text.textContent = 'Enable Animations';
            }
        }

        // ============ Context Menu (Right Click / Variable Insert) ============
        function showVariableMenu(event, inputEl) {
            event.preventDefault();
            contextMenuTarget = inputEl;
            const menu = document.getElementById('variable-context-menu');

            // Build dynamic menu with linkable actions
            let menuHtml = '<div class="context-menu-header">Insert Variable</div>';
            menuHtml += '<div class="context-menu-item" onclick="insertVariable(\'Shortcut Input\')">üì• Shortcut Input</div>';
            menuHtml += '<div class="context-menu-item" onclick="insertVariable(\'Clipboard\')">üìã Clipboard</div>';
            menuHtml += '<div class="context-menu-item" onclick="insertVariable(\'Current Date\')">üìÖ Current Date</div>';
            menuHtml += '<div class="context-menu-item" onclick="insertVariable(\'Device Name\')">üì± Device Name</div>';
            menuHtml += '<div class="context-menu-item" onclick="insertVariable(\'Ask Each Time\')">‚ùì Ask Each Time</div>';

            // Add linkable actions (outputs from previous actions)
            const currentActionId = parseInt(inputEl.dataset.actionId);
            const previousActions = currentActions.filter(a => a.id < currentActionId);
            if (previousActions.length > 0) {
                menuHtml += '<div class="context-menu-divider"></div>';
                menuHtml += '<div class="context-menu-header">Link to Action</div>';
                previousActions.forEach(a => {
                    menuHtml += `<div class="context-menu-item" onclick="insertVariable('${escapeHtml(a.action)} Output')">üîó ${escapeHtml(a.action)}</div>`;
                });
            }

            menu.innerHTML = menuHtml;

            // Position menu - ensure it doesn't go off screen
            let x = event.pageX;
            let y = event.pageY;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');

            // Adjust if going off bottom
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (y - rect.height) + 'px';
                }
                if (rect.right > window.innerWidth) {
                    menu.style.left = (x - rect.width) + 'px';
                }
            }, 0);
        }

        function initContextMenu() {
            document.addEventListener('click', () => {
                document.getElementById('variable-context-menu')?.classList.remove('active');
            });
        }

        function insertVariable(varName) {
            if (!contextMenuTarget) return;
            const start = contextMenuTarget.selectionStart || contextMenuTarget.value.length;
            const end = contextMenuTarget.selectionEnd || contextMenuTarget.value.length;
            const text = contextMenuTarget.value;
            const varText = `{{${varName}}}`;
            contextMenuTarget.value = text.slice(0, start) + varText + text.slice(end);
            contextMenuTarget.focus();
            contextMenuTarget.setSelectionRange(start + varText.length, start + varText.length);
            contextMenuTarget.dispatchEvent(new Event('change'));
            document.getElementById('variable-context-menu')?.classList.remove('active');
        }

        // Mobile: add button to insert variable
        function addVariableInsertButton(inputEl) {
            // Check if on touch device
            if ('ontouchstart' in window) {
                const btn = document.createElement('button');
                btn.className = 'insert-var-btn';
                btn.innerHTML = '{}';
                btn.title = 'Insert Variable';
                btn.onclick = (e) => {
                    e.preventDefault();
                    showVariableMenu(e, inputEl);
                };
                inputEl.parentElement.appendChild(btn);
            }
        }

        // ============ Tutorial System ============
        const tutorialSteps = [
            { target: '#chat-input', title: 'Chat Input', text: 'Describe the shortcut you want to build. The AI will create it for you!' },
            { target: '#plus-menu-btn', title: 'Quick Actions', text: 'Click here to access Force Action, Discussion Mode, and Thinking Mode. Modes turn blue when active.' },
            { target: '#preview-canvas', title: 'Shortcut Preview', text: 'Your shortcut actions will appear here. Click Edit to drag and reorder them!' },
            { target: '#edit-btn', title: 'Edit Mode', text: 'Click Edit to modify, add, or remove actions. You can also right-click inputs to insert variables.' },
            { target: '#top-download-btn', title: 'Download', text: 'When you\'re done, download your shortcut to use in the Shortcuts app!' }
        ];

        function startTutorial() {
            tutorialStep = 0;
            document.getElementById('profile-menu')?.classList.remove('active');
            showTutorialStep();
        }

        function showTutorialStep() {
            const overlay = document.getElementById('tutorial-overlay');
            const spotlight = document.getElementById('tutorial-spotlight');
            const popup = document.getElementById('tutorial-popup');
            const title = document.getElementById('tutorial-title');
            const text = document.getElementById('tutorial-text');
            const indicator = document.getElementById('tutorial-indicator');
            const nextBtn = document.getElementById('tutorial-next');

            if (tutorialStep >= tutorialSteps.length) {
                skipTutorial();
                return;
            }

            const step = tutorialSteps[tutorialStep];
            const targetEl = document.querySelector(step.target);

            overlay.classList.add('active');
            title.textContent = step.title;
            text.textContent = step.text;
            indicator.innerHTML = tutorialSteps.map((_, i) => `<span class="${i === tutorialStep ? 'active' : ''}"></span>`).join('');
            nextBtn.textContent = tutorialStep === tutorialSteps.length - 1 ? 'Done' : 'Next';

            if (targetEl) {
                const rect = targetEl.getBoundingClientRect();
                spotlight.style.left = (rect.left - 10) + 'px';
                spotlight.style.top = (rect.top - 10) + 'px';
                spotlight.style.width = (rect.width + 20) + 'px';
                spotlight.style.height = (rect.height + 20) + 'px';
                spotlight.style.display = 'block';

                // Position popup near target
                const popupWidth = 320;
                const popupHeight = 250; // Safe estimate
                const margin = 20;

                // Horizontal positioning
                let left = rect.left;
                // Clamp left to be within screen
                left = Math.max(margin, Math.min(left, window.innerWidth - popupWidth - margin));
                popup.style.left = left + 'px';

                // Vertical positioning
                let top = rect.bottom + margin;

                // Check if it fits below
                if (top + popupHeight > window.innerHeight - margin) {
                    // Try above
                    const topAbove = rect.top - popupHeight - margin;
                    if (topAbove > margin) {
                        top = topAbove;
                    } else {
                        // If neither fits perfectly, put it where there is more space
                        const spaceBelow = window.innerHeight - rect.bottom;
                        const spaceAbove = rect.top;
                        if (spaceAbove > spaceBelow) {
                            top = Math.max(margin, topAbove); // Clamp to top edge
                        } else {
                            top = Math.min(window.innerHeight - popupHeight - margin, top); // Clamp to bottom edge
                        }
                    }
                }
                popup.style.top = top + 'px';
            }
        }

        function nextTutorialStep() {
            tutorialStep++;
            showTutorialStep();
        }

        function skipTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
            localStorage.setItem('flux_tutorial_done', 'true');
            hasCompletedTutorial = true;
        }

        function checkFirstTimeTutorial() {
            if (!hasCompletedTutorial && currentProject) {
                // Check if this is their first ever project
                const allProjects = JSON.parse(localStorage.getItem('flux_projects')) || [];
                if (allProjects.length === 1) {
                    setTimeout(() => startTutorial(), 500);
                }
            }
        }

        // ============ View Updates ============
        function updateViewButtons() {
            const downloadBtn = document.getElementById('top-download-btn');
            const inWorkspace = !document.getElementById('workspace-view').classList.contains('hidden');
            if (downloadBtn) {
                downloadBtn.style.display = inWorkspace ? 'flex' : 'none';
            }
        }

        // Update showProjectsView and showWorkspaceView
        const originalShowProjectsView = showProjectsView;
        showProjectsView = function () {
            document.getElementById('projects-view').classList.remove('hidden');
            document.getElementById('workspace-view').classList.add('hidden');
            window.history.replaceState({}, '', 'app.html');
            renderProjectsGrid();
            updateViewButtons();
        };

        const originalShowWorkspaceView = showWorkspaceView;
        showWorkspaceView = function () {
            document.getElementById('projects-view').classList.add('hidden');
            document.getElementById('workspace-view').classList.remove('hidden');
            updateViewButtons();
        };

        // Initialize new features
        document.addEventListener('DOMContentLoaded', () => {
            initAnimations();
            initContextMenu();
            updateModeIndicators();
            renderForcedActions();
        });
    </script>
</body>

</html>
