<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CipherStick: Hard - The Digital Enigma</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Confetti + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase compat SDK setup (required before any Firebase usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAiqYse2jzA7l2r6VkwdmdBGs0LzwkXb2Y",
      authDomain: "cipherstick-default-rtdb.firebaseapp.com",
      databaseURL: "https://cipherstick-default-rtdb.firebaseio.com",
      projectId: "cipherstick-default-rtdb",
      storageBucket: "cipherstick-default-rtdb.appspot.com",
      messagingSenderId: "827207706323",
      appId: "1:827207706323:web:a84d3c536b25e0e66c5626"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously().catch(console.error);
  </script>

  <style>
     :root {
      --accent-color: #ff0000; /* Dark red accent */
      --text-color: #ffffff;   /* Primary text color */
      --border-hover: rgba(255, 0, 0, 0.4);
      --warning-color: #f1c40f;
      --danger-color: #e74c3c;
      --success-color: #28a745;
    }

    /* Reset & Box Sizing */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* BODY: With background image + an optional subtle black overlay */
    body {
      font-family: 'Open Sans', sans-serif;
      background: url('HARD_BG.png') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 0 1rem 1rem 1rem;
      color: var(--text-color);
      text-shadow: 1px 1px 3px #000; /* Add shadow for readability */
    }
    /* If you want a subtle overlay to help text clarity, uncomment:
    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      pointer-events: none;
      z-index: -1;
    }
    */

    /* HEADER: no background so it blends in */
    header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      box-shadow: none;
    }
    header img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* MAIN CONTAINER: Transparent, so background shows through */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: transparent; /* fully transparent container */
      border-radius: 15px;
      box-shadow: none; /* removing heavy shadows if you want it truly transparent */
      flex: 1;
      margin-top: calc(100vw * 0.18);
      padding: 1rem;
    }

    .intro {
      margin-bottom: 2rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.6); /* Keep it transparent */
      border-left: 4px solid var(--accent-color);
      border-radius: 8px;
      font-size: 1.1rem;
      line-height: 1.6;
    }

    .intro p {
      margin-bottom: 1rem;
    }

    /* DETAILS + SUMMARY box for OSINT Tools */
    details {
      background: rgba(0, 0, 0, 0.6);
      border-left: 4px solid var(--accent-color);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    summary {
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      list-style: none;
      outline: none;
      color: var(--text-color);
      text-shadow: 1px 1px 2px #000;
    }
    details ul li {
      margin: 0.5rem 0;
    }

    /* QUESTION BLOCKS */
    .question {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: black; /* Make it truly see-through */
      box-shadow: none;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    .question:hover {
      border-color: white;
    }
    .question .question-text {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1.1rem;
      color: white;
      margin-bottom: 0.5rem;
      text-shadow: 1px 1px 2px #000;
    }
    .question .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .question input[type="text"] {
      flex: 1;
      padding: 0.6rem;
      font-size: 1rem;
      color: var(--text-color);
      background-color: rgba(0,0,0,0.5); /* Slightly dark to show text clearly */
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      text-shadow: none; /* remove text shadow for inputs if you prefer */
    }
    .question input[type="text"]:focus {
      border-color: white;
      outline: none;
      box-shadow: 0 0 8px var(--border-hover);
    }

    /* HINT + CHECK BUTTONS */
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }
    .btn-hint, .btn-check {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
      color: #fff;
      text-shadow: none;
    }
    .btn-hint {
      background: linear-gradient(135deg, #444, #777);
    }
    .btn-hint:hover {
      background: linear-gradient(135deg, #777, #999);
      transform: translateY(-3px);
    }
    .btn-check {
      background: linear-gradient(135deg, #b30000, #7a0000);
    }
    .btn-check:hover {
      background: linear-gradient(135deg, #ff0000, #990000);
      transform: translateY(-3px);
    }

    /* HINT */
    .hint {
      margin-top: 0.5rem;
      background: rgba(0,0,0,0.5);
      border-left: 4px solid var(--accent-color);
      padding: 0.5rem;
      border-radius: 6px;
      font-style: italic;
      color: #fff;
      display: none;
    }

    /* RESULT TEXT */
    .result {
      font-weight: bold;
      margin-top: 0.5rem;
      font-size: 1rem;
      min-height: 1.2rem;
      color: var(--warning-color);
      text-shadow: 1px 1px 2px #000;
    }
    .result.incorrect {
      color: var(--danger-color);
    }

    /* TOAST */
    #toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.7);
      animation: slideIn 0.5s ease-out;
      color: #fff;
      background: #b30000;
      font-family: 'Poppins', sans-serif;
      text-shadow: none;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* FINAL MESSAGE */
    #finalMessage {
      text-align: center;
      margin-top: 2rem;
      padding: 1.5rem;
      border: 2px solid var(--warning-color);
      border-radius: 10px;
      background: rgba(0,0,0,0.5);
      color: var(--warning-color);
      font-family: 'Poppins', sans-serif;
      display: none;
      text-shadow: 1px 1px 2px #000;
    }
    #finalMessage h2 {
      color: var(--warning-color);
      margin-bottom: 1rem;
      text-shadow: 1px 1px 2px #000;
    }

    /* VICTORY OVERLAY */
    #victoryOverlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Poppins', sans-serif;
      font-size: 3rem;
      color: var(--warning-color);
      background: rgba(0,0,0,0.8);
      padding: 2rem 4rem;
      border-radius: 10px;
      z-index: 1500;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
      text-shadow: 1px 1px 3px #000;
    }

    /* NAME INPUT MODAL */
    .name-input-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
      z-index: 2000;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      color: #fff;
    }
    .name-input-modal input {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #333;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border-radius: 6px;
      margin-bottom: 1rem;
      width: 80%;
      text-shadow: none;
    }
    .name-input-modal button {
      padding: 0.75rem 1.5rem;
      background: var(--warning-color);
      color: #111;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      text-shadow: none;
    }
    .name-input-modal button:hover {
      background: #d4ac0d;
      transform: scale(1.05);
    }

    /* CERTIFICATE BUTTON */
    .btn-certificate {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, #b30000, #7a0000);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: background 0.3s ease, transform 0.3s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.5);
      text-shadow: none;
    }
    .btn-certificate:hover {
      background: linear-gradient(135deg, #ff0000, #990000);
      transform: translateY(-3px);
    }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 1rem;
      color: #ccc;
      font-size: 0.9rem;
      margin-top: 1rem;
      text-shadow: 1px 1px 2px #000;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      header img { height: auto; }
      .container { padding: 1rem; }
      .question { padding: 0.8rem; }
      .btn-hint, .btn-check { padding: 0.5rem 1rem; font-size: 0.9rem; }
      #victoryOverlay { font-size: 2rem; padding: 1rem 2rem; }
    }
    @media print {
      body { background: #fff !important; color: #000; }
      header, footer, .container { display: none !important; }
    }
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M2NFQ1M6LR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M2NFQ1M6LR');
</script>
<body>
  <header>
    <a href="index.html">
    <img src="HARD.png" alt="CipherStick: Hard"/>
  </a>
  </header>

  <div class="container">
    <div class="intro" id="introText">
    </div>
    <details style="margin: 1rem 0; background: rgba(0, 0, 0, 0.6); border-left: 5px solid var(--accent-color); padding: 1rem; border-radius: 8px;">
      <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem;">üß∞ Useful OSINT Tools (click to expand)</summary>
      <ul style="margin-top: 0.75rem; padding-left: 1.2rem; line-height: 1.7;">
        <li><a href="https://www.metadata2go.com/" target="_blank" style="color: #fff;">üì∑ Metadata2Go</a> ‚Äì Extract metadata from images</li>
        <li style="color: #fff;">üõ† Browser <strong>Inspect Tool</strong> ‚Äì Right click ‚Üí Inspect ‚Üí View source & elements</li>
        <li><a href="https://www.base64decode.org/" target="_blank" style="color: #fff;">üìÇ Base64 Decode</a> ‚Äì Decode encoded strings</li>
        <li><a href="https://www.gps-coordinates.net/" target="_blank" style="color: #fff;">üìç GPS Coordinates Lookup</a></li>
        <li><a href="https://archive.org/web/" target="_blank" style="color: #fff;">üï∞Ô∏è Wayback Machine</a> ‚Äì View old versions of websites</li>
        <li><a href="https://www.osintcurio.us/" target="_blank" style="color: #fff;">üîç OSINT Curious Project</a> ‚Äì Great OSINT blog & tools</li>
        <li><a href="https://dnsdumpster.com/" target="_blank" style="color: #fff;">üåê DNSDumpster</a> ‚Äì DNS recon & infrastructure mapping</li>
        <li><a href="https://www.shodan.io/" target="_blank" style="color: #fff;">üõ∞Ô∏è Shodan</a> ‚Äì Scan internet-connected devices</li>
        <li><a href="https://exif.tools/" target="_blank" style="color: #fff;">üß¨ EXIF.tools</a> ‚Äì Analyze hidden metadata in images</li>
        <li><a href="https://haveibeenpwned.com/" target="_blank" style="color: #fff;">üïµÔ∏è‚Äç‚ôÇÔ∏è Have I Been Pwned</a> ‚Äì Check for compromised emails</li>      
        <li>IMPORTANT NOTE: Some of these sites may not be used in this puzzle, and there may be some other sites needed throught the challenge. With OSINT, you have to be prepared for everything.</li>
      </ul>
    </details>

    <div id="questionsContainer"></div>

    <div id="finalMessage">
      <h2 style="color: #ffcc00;">You beat it!</h2>
      <button class="btn-certificate" onclick="openCertificateModal()">Claim Your Certificate</button>
    </div>
  </div>

  <div id="victoryOverlay">You beat it!</div>

  <div id="nameInputModal" class="name-input-modal">
    <h2 style="color: #ffcc00;">Enter Your Name</h2>
    <input type="text" id="userNameInput" placeholder="Your Name" />
    <button onclick="downloadCertificate()">Download Certificate</button>
  </div>

  <div id="toast"></div>

  <footer>
    <p>¬© 2025 CipherStick. All rights reserved.</p>
  </footer>

<script>
function loadIntroText() {

  let prefixInfo = "";

  if (prefixEnabled) {
    prefixInfo = `<p>All answers must be in the format <code>${requiredPrefix}</code>ANSWER<code>${requiredSuffix}</code>.</p>`;
  }

  const introHTML = `
    <p>Welcome to <strong>The Digital Enigma</strong>, an advanced open-source intelligence (OSINT) challenge designed to push your skills to their limits. You'll investigate the mysterious disappearance of Taylor, a digital artist whose final clues lie scattered across social media, images, and hidden data trails.</p>
    <p>Your investigation begins at: <a href="https://taylorartx.wordpress.com" target="_blank" style="color:#fff;">taylorartx.wordpress.com</a><br>Password: <code style="background:rgba(0,0,0,0.5);">TaylorPaints</code></p>
    <p>Use your wits, curiosity, and OSINT tools to uncover secrets buried in metadata, inspect source code, decode messages, and follow digital footprints to uncover the truth.</p>
    <p>If you are new to OSINT, I reccomend <a href="https://www.youtube.com/watch?v=Sa5LbKqCmFI" target="_blank">this video</a> to familiarize yourself with it</p>

    ` + prefixInfo + `

    <p>Good luck, Agent.</p>
  `;
  document.getElementById("introText").innerHTML = introHTML;
}

/* Q&A Array */
const questions = [
  { question: "What is the URL of the website where the investigation begins?", hint: "The WordPress site mentioned in the case briefing.", answer: "taylorartx.wordpress.com" },
  { question: "Does Taylor have a boss?", hint: "", answer: "no" },
  { question: "When was Taylor's most recent blog post published?", hint: "Check the post date. Format: MM/DD/YY", answer: "04/08/25" },
  { question: "What is Taylor's WordPress username?", hint: "Look under the post title for author info.", answer: "taylorisgoodatart" },
  { question: "What is the filename of the uploaded painting?", hint: "Check the image URL for filename + extension.", answer: "bridge.jpeg" },
  { question: "Where is the image hosted?", hint: "Check the image source link.", answer: "GitHub" },
  { question: "What is Taylor's GitHub username?", hint: "It's in the image URL and repo name.", answer: "TaylorArtX" },
  { question: "What's the hidden message in the photo?", hint: "Extract metadata and decode any base64 text.", answer: "art is the key" },
  { question: "Where was the photo painted?", hint: "Metadata may contain GPS coordinates.", answer: "37.7749¬∞ N, 122.4194¬∞ W" },
  { question: "What is the unlock code for the first secret in the repo?", hint: "It looked encoded, but is it really?", answer: "IFZXI===" },
  { question: "What‚Äôs the password to the WordPress site?", hint: "Check the case briefing above.", answer: "TaylorPaints" },
  { question: "What platform is the embedded video hosted on?", hint: "Hover over the embedded video or check source code.", answer: "Vimeo" },
  { question: "What date was the video recorded?", hint: "Use MM/DD/YY.", answer: "04/08/25" },
  { question: "What airline is Taylor flying back with?", hint: "Search the flight number, use 3-letter airline code (e.g. UAL).", answer: "UAL" },
  { question: "What is Taylor‚Äôs full flight number?", hint: "Format: UALXXXX", answer: "UAL1517" },
  { question: "What state does Taylor live in?", hint: "Find the destination airport and deduce the state.", answer: "texas" },
  { question: "Which airport did the flight land at?", hint: "Use the flight info to determine the IATA code.", answer: "DFW" },
  { question: "What's the second hidden message in the video?", hint: "Listen closely and look for Morse code.", answer: "My site /cipher" },
  { question: "What is Taylor's X (Twitter) handle?", hint: "Check the profile linked from the GitHub readme.", answer: "@taylorartx" },
  { question: "What is the second repository unlock code?", hint: "Decode the hex or base64 string posted on X.", answer: "bridge" },
  { question: "Which site is referenced in his X post (hex encoded)?", hint: "Convert the hex code to readable text.", answer: "pastebin" },
  { question: "Where was Taylor on April 8th? (exact coordinates)", hint: "Clue found in the second repo secret.", answer: "37.7833¬∞ N, 122.4167¬∞ W" },
  { question: "What is Taylor's email address?", hint: "Found in the hidden page; decode the message.", answer: "taylorpaints@proton.me" }
];

const storageKeyPrefix = "OSINT-HARD";
const requiredPrefix = "pr{";
const requiredSuffix = "}";
const prefixEnabled = requiredPrefix.trim() !== "";
let testMode = false;
let quizCompleted = false;
let checkedQuestions = new Array(questions.length).fill(false);
let answeredCorrectly = new Array(questions.length).fill(false);

function normalizeInput(str) {
  return str.toLowerCase()
    .replace(/[‚Äô‚Äò]/g, "'")
    .replace(/[‚Äú‚Äù]/g, '"')
    .normalize("NFKC")
    .trim();
}

function showToastMessage(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.background = (type === "correct") ? "#28a745" : "#e74c3c";
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function checkAnswer(index, showBanner = true) {
  const inputField = document.getElementById(`input-${index}`);
  const userInputRaw = inputField.value;
  const userInput = normalizeInput(userInputRaw);
  const expected = normalizeInput(`${requiredPrefix}${questions[index].answer}${requiredSuffix}`);
  const questionDiv = document.getElementById(`question-${index}`);
  const questionText = questionDiv.firstChild

  localStorage.setItem(`${storageKeyPrefix}-input-${index}`, userInputRaw);
  if (userInput !== "") checkedQuestions[index] = true;

  if (userInput === expected) {
    if (!answeredCorrectly[index]) {
      answeredCorrectly[index] = true;
      questionDiv.style.borderColor = 'green';
      inputField.style.backgroundColor = "rgba(0, 255, 0, 0.1)";
      questionText.style.color = "rgb(0,255,0)"
      inputField.style.borderColor = "rgb(0,255,0)"

      if (showBanner) {
        showToastMessage("Correct!", "correct");
        confetti({ particleCount: 150, spread: 160, origin: { y: 0.6 } });
      }
    }
  } else {
    questionDiv.style.borderColor = 'red';
    inputField.style.backgroundColor = "rgba(255, 0, 0, 0.1)";
    questionText.style.color = "rgb(255,0,0)"
    inputField.style.borderColor = "rgb(255,0,0)"


    if (showBanner) {
      showToastMessage(`Incorrect answer for question ${index + 1}`, "incorrect");
    }
  }
  checkAllAnswers();
}

function checkAllAnswers() {
  const finalMessage = document.getElementById('finalMessage');
  let allCorrect = true;
  for (let i = 0; i < questions.length; i++) {
    const inputVal = normalizeInput(document.getElementById(`input-${i}`).value);
    const expected = normalizeInput(`${requiredPrefix}${questions[i].answer}${requiredSuffix}`);
    if (inputVal !== expected || !checkedQuestions[i]) {
      allCorrect = false;
      break;
    }
  }
  if (allCorrect && !quizCompleted) {
    quizCompleted = true;
    finalMessage.style.display = 'block';
    startVictoryConfetti();
    showVictoryOverlay();
  } else if (!allCorrect) {
    finalMessage.style.display = 'none';
    quizCompleted = false;
  }
}

function toggleHint(index) {
  const hint = document.getElementById(`hint-${index}`);
  hint.style.display = (hint.style.display === 'none' || hint.style.display === '') ? 'block' : 'none';
}

function generateQuestions() {
  const container = document.getElementById('questionsContainer');
  questions.forEach((q, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question';
    questionDiv.id = `question-${index}`;

    const questionText = document.createElement('div');
    questionText.className = 'question-text';
    questionText.textContent = `${index + 1}. ${q.question}`;
    questionDiv.appendChild(questionText);

    const inputGroup = document.createElement('div');
    inputGroup.className = 'input-group';

    const input = document.createElement('input');
    input.type = 'text';
    input.id = `input-${index}`;
    // A simple placeholder that hides actual text:
    const answer = requiredPrefix + q.answer + requiredSuffix
    input.placeholder = answer.replace(/[^{} ]/g, '*');
    input.oninput = () => localStorage.setItem(`${storageKeyPrefix}-input-${index}`, input.value);
    inputGroup.appendChild(input);

    const btnGroup = document.createElement('div');
    btnGroup.className = 'btn-group';

    if (q.hint) {
      const hintBtn = document.createElement('button');
      hintBtn.className = 'btn-hint';
      hintBtn.textContent = 'Show Hint';
      hintBtn.onclick = () => toggleHint(index);
      btnGroup.appendChild(hintBtn);
    }

    const checkBtn = document.createElement('button');
    checkBtn.className = 'btn-check';
    checkBtn.textContent = 'Check Answer';
    checkBtn.onclick = () => checkAnswer(index, true);
    btnGroup.appendChild(checkBtn);

    inputGroup.appendChild(btnGroup);
    questionDiv.appendChild(inputGroup);

    if (q.hint) {
      const hintDiv = document.createElement('div');
      hintDiv.className = 'hint';
      hintDiv.id = `hint-${index}`;
      hintDiv.textContent = q.hint;
      questionDiv.appendChild(hintDiv);
    }

    const resultDiv = document.createElement('div');
    resultDiv.className = 'result';
    resultDiv.id = `result-${index}`;
    questionDiv.appendChild(resultDiv);

    container.appendChild(questionDiv);
  });
}

function restoreInputs() {
  questions.forEach((_, i) => {
    const saved = localStorage.getItem(`${storageKeyPrefix}-input-${i}`);
    if (saved) {
      const inputField = document.getElementById(`input-${i}`);
      inputField.value = saved;
      checkAnswer(i, false);
    }
  });
}

function startVictoryConfetti() {
  const interval = setInterval(() => {
    confetti({ particleCount: 300, spread: 150, origin: { x: 0, y: 0.5 } });
    confetti({ particleCount: 300, spread: 150, origin: { x: 1, y: 0.5 } });
  }, 350);
  setTimeout(() => clearInterval(interval), 10000);
}

function showVictoryOverlay() {
  const overlay = document.getElementById('victoryOverlay');
  overlay.style.opacity = '1';
  setTimeout(() => { overlay.style.opacity = '0'; }, 3000);
}

function openCertificateModal() {
  document.getElementById('nameInputModal').style.display = 'block';
}

function downloadCertificate() {
  const userName = document.getElementById('userNameInput').value || '[Your Name]';
  const certificateDate = new Date().toLocaleDateString();
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF({ orientation: 'landscape', unit: 'in', format: [11, 8.5] });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  // Simple red-themed certificate
  doc.setFillColor(70, 0, 0);
  doc.rect(0, 0, pageWidth, pageHeight, 'F');

  doc.setDrawColor(241, 196, 15);
  doc.setLineWidth(0.25);
  doc.rect(0.25, 0.25, pageWidth - 0.5, pageHeight - 0.5);

  doc.setFont('times', 'bolditalic');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(28);
  doc.text('Certificate of Mastery', pageWidth / 2, 1.5, { align: 'center' });

  doc.setFontSize(18);
  doc.text('This certifies that', pageWidth / 2, 2.5, { align: 'center' });

  doc.setFontSize(24);
  doc.text(userName, pageWidth / 2, 3.5, { align: 'center' });

  doc.setFontSize(18);
  doc.text('has successfully completed', pageWidth / 2, 4.5, { align: 'center' });
  doc.text('CipherStick: HARD - The Digital Enigma', pageWidth / 2, 5, { align: 'center' });

  doc.setFontSize(16);
  doc.text(`on ${certificateDate}`, pageWidth / 2, 5.5, { align: 'center' });
  doc.text('Awarded by: CipherStick Team', pageWidth / 2, 6.5, { align: 'center' });

  doc.setFontSize(14);
  doc.text('This achievement recognizes your elite investigative ability and OSINT expertise.', pageWidth / 2, 7.5, { align: 'center' });

  // Trigger download
  doc.save("DigitalEnigma-Certificate.pdf");
  // Firebase completion logging (runs only when certificate is generated)
  logCompletion("hard");
  // Clear localStorage entries after saving (slight delay gives browsers time to start the download)
  setTimeout(() => {
    for (let i = 0; i < questions.length; i++) {
      localStorage.removeItem(`${storageKeyPrefix}-input-${i}`);
    }
  }, 200);

  document.getElementById('nameInputModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  loadIntroText();
  generateQuestions();
  restoreInputs();
});
</script>
<script>
// --- Firebase compat attempt and completion logging ---
// For logging attempts (one per week per user)
const userAttemptIdKey = 'cipherstick_attempt_hard';
firebase.auth().onAuthStateChanged(function(user) {
  if (!user) return;
  const userAttemptId = user.uid;
  const now = Date.now();
  const lastAttempt = localStorage.getItem(userAttemptIdKey);
  if (!lastAttempt || now - parseInt(lastAttempt) > 7 * 24 * 60 * 60 * 1000) {
    try {
      // Use a unique key so multiple attempts are possible, but only one per week in localStorage
      const uniqueKey = firebase.database().ref().push().key;
      firebase.database().ref(`/attempts/hard/${userAttemptId}/${uniqueKey}`).set({
        timestamp: now
      }).then(function() {
        console.log("‚úÖ Logged attempt");
        localStorage.setItem(userAttemptIdKey, now.toString());
      }).catch(function(err) {
        console.warn("‚ùå Failed to log attempt:", err.message);
      });
    } catch (err) {
      console.warn("‚ùå Failed to log attempt:", err.message);
    }
  }
});

// Universal completion logging function
function logCompletion(difficulty) {
  const user = firebase.auth().currentUser;
  if (!user) {
    console.warn("User not authenticated for logging completion.");
    return;
  }
  const uid = user.uid;
  // Only log completion if attempts exist for this user/difficulty
  firebase.database().ref(`/attempts/${difficulty}/${uid}`).once('value')
    .then(function(attemptSnap) {
      if (!attemptSnap.exists()) {
        console.warn("No attempts found for this user/difficulty; skipping completion log.");
        return;
      }
      // Only log a new completion if completions < attempts
      firebase.database().ref(`/completions/${difficulty}/${uid}`).once('value')
        .then(function(completionSnap) {
          const attemptsCount = attemptSnap.numChildren();
          const completionsCount = completionSnap.exists() ? completionSnap.numChildren() : 0;
          if (completionsCount < attemptsCount) {
            // Use a unique key for each completion
            const uniqueKey = firebase.database().ref().push().key;
            firebase.database().ref(`/completions/${difficulty}/${uid}/${uniqueKey}`).set({
              timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(function() {
              console.log("‚úÖ Completion logged");
            }).catch(function(err) {
              console.warn("‚ùå Failed to log completion:", err.message);
            });
          } else {
            console.warn("üõë Already logged same number of completions as attempts");
          }
        });
    });
}
// Make available globally for downloadCertificate
window.logCompletion = logCompletion;
</script>
</body>
</html>