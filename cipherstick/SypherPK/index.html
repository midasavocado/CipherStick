<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SypherPK - THE LIST</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/png" href="icon.png">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #181818;
      padding: 1rem 2rem;
      border-bottom: 2px solid #ff1a1a;
      transition: background 0.3s ease;
    }
    header:hover {
      background: #222;
    }
    header h1 {
      font-size: 2.6rem;
      margin: 0;
      font-weight: 900;
      letter-spacing: 1.2px;
      color: #ff1a1a;
      user-select: none;
      transition: transform 0.3s ease;
    }
    header h1:hover {
      transform: scale(1.05);
    }
    header .subtitle {
      font-size: 1.2rem;
      color: #ff4d4d;
      font-weight: 400;
      display: block;
      letter-spacing: 0.6px;
    }
    nav button {
      background: #ff1a1a;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.5rem;
      margin-left: 1rem;
      font-size: 1.1rem;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.3s ease, transform 0.2s ease;
      user-select: none;
    }
    nav button.hidden { display: none; }
    nav button:hover {
      background: #ff4d4d;
      transform: scale(1.1);
    }
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.1rem 1.5rem 0.2rem 1.5rem;
      min-height: 80vh;
      max-width: 100vw;
    }
    #listsContainer {
      display: flex;
      gap: 2.5rem;
      width: 100%;
      max-width: 960px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .list-section {
      background: #181818;
      border: 2px solid #ff1a1a;
      border-radius: 12px;
      padding: 1.8rem 1.5rem 1.5rem 1.5rem;
      width: 350px;
      flex: 1 1 auto;
      max-height: calc(100vh - 300px);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }
    .list-section:hover {
      transform: scale(1.03);
      box-shadow: 0 0 15px #ff1a1aaa;
    }
    .list-section h2 {
      margin: 0 0 1rem 0;
      font-size: 1.7rem;
      text-align: center;
      color: #ff1a1a;
      letter-spacing: 1.2px;
      font-weight: 800;
      user-select: none;
    }
    .list-section.nice h2 {
      color: #ffffff;
    }
.list-section.naughty h2 {
  color: #ff5555;
}
.list-section.naughty {
  border: 2px solid #ff5555;
}
.list-section.naughty ul.user-list li {
  border: 1.5px solid #ff5555;
}
.list-section.naughty ul.user-list li:hover {
  border-color: #ff7777;
}
    .search-box {
      margin-bottom: .5rem;
      display: flex;
      align-items: center;
    }
    .search-box input {
      flex: 1;
      border: 1.5px solid #ff1a1a;
      border-radius: 7px;
      padding: 0.5rem 0.9rem;
      font-size: 1.1rem;
      background: #2a0000;
      color: #ffb3b3;
      outline: none;
      transition: border-color 0.3s ease, color 0.3s ease;
    }
    .search-box input:focus {
      border-color: #ff4d4d;
      box-shadow: 0 0 8px #ff4d4daa;
    }
    /* Nice List search box: green border and text */
    .list-section.nice .search-box input {
      border: 1.5px solid #27d147;
      color: #27d147;
      background: #112617;
    }
    .list-section.nice .search-box input:focus {
      border-color: #34e96e;
      box-shadow: 0 0 8px #27d147aa;
    }
    ul.user-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #ff1a1a transparent;
    }
    ul.user-list::-webkit-scrollbar {
      width: 8px;
    }
    ul.user-list::-webkit-scrollbar-thumb {
      background-color: #ff1a1a;
      border-radius: 10px;
    }
    ul.user-list li {
      background: #222;
      border: 1.5px solid #ff1a1a;
      margin-bottom: 0.2rem;
      border-radius: 7px;
      padding: 0.6rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.9rem;
      font-size: 1.1rem;
      transition: background 0.3s, border 0.3s, transform 0.2s ease;
      cursor: grab;
      user-select: none;
    }
    ul.user-list li:hover {
      background: #181818;
      color: #ff1a1a;
      border-color: #ff4d4d;
      transform: scale(1.02);
    }
    ul.user-list li.dragging {
      opacity: 0.5;
      border: 2.5px dashed #ffb3b3;
      background: #333;
      cursor: grabbing;
    }
    /* Nice List specific styles */
    .list-section.nice {
      border: 2px solid #27d147;
    }
    .list-section.nice ul.user-list li {
      border: 1.5px solid #27d147;
      color: #27d147;
    }
    .list-section.nice ul.user-list li:hover {
      background: #181818;
      color: #2fff5c;
      border-color: #34e96e;
    }
    ul.user-list li .remove-btn {
      margin-left: auto;
      background: none;
      border: none;
      color: #ff6666;
      font-size: 1.5rem;
      cursor: pointer;
      display: none;
      transition: color 0.3s ease;
      user-select: none;
    }
    ul.user-list li .remove-btn:hover {
      color: #ff1a1a;
    }
    ul.user-list li.editable .remove-btn {
      display: inline;
    }
    ul.user-list li a {
      color: #fff;
      text-decoration: underline;
      font-weight: 600;
      word-break: break-word;
      user-select: text;
      transition: color 0.3s ease;
      text-shadow: 0 0 4px #000, 0 0 2px #fff;
    }
    ul.user-list li a:hover {
      color: #ff4848;
      text-shadow: 0 0 6px #ffe066, 0 0 2px #000;
    }
    .list-section.nice ul.user-list li a {
      color: #ffffff;
      /* Softer green glow for readability */
      text-shadow: 0 0 2px #27d147, 0 0 1px #fff;
      font-weight: 700;
    }
    .list-section.nice ul.user-list li a:hover {
      color: #70ff8a;
      text-shadow: 0 0 4px #70ff8a, 0 0 1px #fff;
    }
    .add-user-form {
      margin: 1rem 0 1rem 0;
      display: flex;
      gap: 0.9rem;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease;
      user-select: none;
    }
    .add-user-form.hidden {
      opacity: 0;
      height: 0;
      overflow: hidden;
      pointer-events: none;
      margin: 0;
      padding: 0;
    }
    .add-user-form input[type="text"] {
      border: 1.5px solid #ff1a1a;
      border-radius: 7px;
      padding: 0.5rem 0.9rem;
      font-size: 1.1rem;
      background: #222;
      color: #fff;
      outline: none;
      width: 180px;
      transition: border-color 0.3s ease;
    }
    .add-user-form input[type="text"]:focus {
      border-color: #ff4d4d;
      box-shadow: 0 0 10px #ff4d4dbb;
    }
 .add-user-form select {
  border: 1.5px solid #ff1a1a;
  border-radius: 7px;
  padding: 0.5rem 0.9rem;
  height: auto;
  font-weight: 700;
      background: #181818;
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    .add-user-form select:hover, .add-user-form select:focus {
      border-color: #ff4d4d;
      box-shadow: 0 0 8px #ff4d4dbb;
    }
    .add-user-form button {
      background: #ff1a1a;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.5rem 1.3rem;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      user-select: none;
    }
    .add-user-form button:hover {
      background: #ff4d4d;
      transform: scale(1.05);
    }
    #adminNotice {
      margin-top: 1rem;
      text-align: center;
      color: #ff6666;
      font-size: 1.1rem;
      font-weight: 600;
      min-height: 1.3em;
      user-select: none;
    }
    /* Login modal */
    #loginModal {
      border: none;
      border-radius: 12px;
      background: #181818;
      color: #fff;
      padding: 2.5rem 3rem;
      box-shadow: 0 10px 40px #000c;
      font-size: 1.2rem;
      user-select: none;
    }
    #loginModal label, #loginModal menu {
      display: block;
      margin-top: 1.3rem;
    }
    #loginModal input[type="password"] {
      width: 100%;
      border: 1.5px solid #ff1a1a;
      border-radius: 7px;
      padding: 0.5rem 0.9rem;
      background: #222;
      color: #fff;
      font-size: 1.1rem;
      outline: none;
      user-select: text;
      transition: border-color 0.3s ease;
    }
    #loginModal input[type="password"]:focus {
      border-color: #ff4d4d;
      box-shadow: 0 0 10px #ff4d4dbb;
    }
    #loginModal .error {
      color: #ff6666;
      margin-top: 0.9rem;
      display: block;
      font-size: 1.1rem;
      min-height: 1.3em;
      user-select: none;
    }
    @media (max-width: 900px) {
      #listsContainer {
        flex-direction: column;
        align-items: center;
        gap: 1.8rem;
      }
      .list-section {
        width: 95vw;
        max-width: 98vw;
      }
      .add-user-form {
        flex-wrap: wrap;
        justify-content: center;
      }
      .add-user-form input[type="text"], .add-user-form select {
        width: 100%;
        max-width: 300px;
      }
    }
    @media (max-width: 480px) {
      header h1 {
        font-size: 1.8rem;
      }
      header .subtitle {
        font-size: 1rem;
      }
      nav button {
        font-size: 0.9rem;
        padding: 0.4rem 1rem;
      }
      .list-section {
        min-height: 400px;
      }
      ul.user-list li {
        font-size: 1rem;
        padding: 0.5rem 0.8rem;
      }
      .add-user-form button {
        font-size: 1rem;
        padding: 0.4rem 1rem;
      }
    }
  </style>
</head>
<body>
 <header style="gap: 1.5rem;">
  <div>
    <h1>SypherPK<br><span class="subtitle">THE LIST</span></h1>
  </div>
    <nav>
      <button id="loginBtn">Admin Login</button>
      <button id="logoutBtn" class="hidden">Logout</button>
    </nav>
  </header>
  <main>
    <form id="addUserForm" class="add-user-form hidden">
      <input type="text" id="twitchUsername" placeholder="Twitch username" required autocomplete="off" />
      <select id="listChoice" style="height: 4.8vh;">
        <option value="nice">Nice List</option>
        <option value="naughty">Naughty List</option>
      </select>
      <button type="submit">Add</button>
    </form>
    <div id="adminNotice"></div>
    <div id="userValidationStatus" style="margin: 0.5rem auto 1rem auto; text-align: center; font-size: 1.05rem; font-weight: 500; color: #ffcccc; min-height: 1.3em;"></div>
    <div id="loadingIndicator" style="margin-top: 1rem; font-size: 1.2rem; color: #bbb; text-align: center;">Loading players...</div>
    <div id="listsContainer">
      <section class="list-section nice">
        <h2>Nice List</h2>
        <div class="search-box">
          <input type="text" id="searchNice" placeholder="Search Nice List..." autocomplete="off" />
        </div>
        <ul id="niceList" class="user-list" data-list="nice"></ul>
      </section>
      <section class="list-section naughty">
        <h2>Naughty List</h2>
        <div class="search-box">
          <input type="text" id="searchNaughty" placeholder="Search Naughty List..." autocomplete="off" />
        </div>
        <ul id="naughtyList" class="user-list" data-list="naughty"></ul>
      </section>
    </div>
  </main>
  <dialog id="loginModal">
    <form id="loginForm" method="dialog" autocomplete="off">
      <h2>Admin Login</h2>
      <label>Password:
        <input type="password" id="passwordInput" required autofocus>
      </label>
      <menu>
        <button value="cancel" onclick="document.getElementById('loginModal').close()">Cancel</button>
        <button id="loginSubmit" value="default">Log In</button>
      </menu>
      <output id="loginError" class="error"></output>
    </form>
  </dialog>
  <!-- Firebase setup scaffold -->
  <script type="module">
    // Firebase imports and initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxQTPd-xZy-Iyid3Wxw4i9_TdYUXd543o",
      authDomain: "sypherpk-fd245.firebaseapp.com",
      databaseURL: "https://sypherpk-fd245-default-rtdb.firebaseio.com",
      projectId: "sypherpk-fd245",
      storageBucket: "sypherpk-fd245.firebasestorage.app",
      messagingSenderId: "613263655126",
      appId: "1:613263655126:web:43c2522276c1606c1f4977",
      measurementId: "G-DD7Z3KNKGS"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // State and admin logic
    const STATE = {
      loggedIn: localStorage.getItem('thelist_loggedIn') === 'true',
      nice: [],
      naughty: [],
      dragSrc: null,
      admin: false,
    };
    const $ = id => document.getElementById(id);
    // UI refs
    const ui = {
      loginBtn: $('loginBtn'),
      logoutBtn: $('logoutBtn'),
      loginModal: $('loginModal'),
      loginForm: $('loginForm'),
      loginError: $('loginError'),
      passwordInput: $('passwordInput'),
      addUserForm: $('addUserForm'),
      twitchUsername: $('twitchUsername'),
      listChoice: $('listChoice'),
      niceList: $('niceList'),
      naughtyList: $('naughtyList'),
      searchNice: $('searchNice'),
      searchNaughty: $('searchNaughty'),
      adminNotice: $('adminNotice'),
      userValidationStatus: $('userValidationStatus'),
      loadingIndicator: $('loadingIndicator')
    };

    // Alphabetical sort helper
    function sortedUsers(arr) {
      return [...arr].sort((a, b) =>
        a.username.toLowerCase().localeCompare(b.username.toLowerCase())
      );
    }

    // Render functions
    function renderList(listName, filter='') {
      const isNice = listName === 'nice';
      const ul = isNice ? ui.niceList : ui.naughtyList;
      const arr = isNice ? STATE.nice : STATE.naughty;
      ul.innerHTML = '';
      if (arr.length === 0) return;
      // Show the latest user (last in array) at the top, rest sorted below (session only)
      const latestUser = arr[arr.length - 1];
      const sorted = sortedUsers(arr.filter(u => u !== latestUser));
      [latestUser, ...sorted].forEach((user, idx) => {
        if (filter && !user.username.toLowerCase().includes(filter.toLowerCase())) return;
        const li = document.createElement('li');
        li.setAttribute('draggable', STATE.admin ? 'true' : 'false');
        li.dataset.idx = arr.findIndex(u => u.username === user.username);
        li.dataset.list = listName;
        li.innerHTML = `
          <a href="https://twitch.tv/${encodeURIComponent(user.username)}" target="_blank" rel="noopener noreferrer">${user.username}</a>
          <button class="remove-btn" title="Remove user" tabindex="-1">&times;</button>
        `;
        if (STATE.admin) li.classList.add('editable');
        // Remove handler
        li.querySelector('.remove-btn').onclick = (e) => {
          e.stopPropagation();
          if (!STATE.admin) return;
          // Remove from original (unsorted) array by username
          const ix = arr.findIndex(u => u.username === user.username);
          if (ix >= 0) arr.splice(ix, 1);
          saveLists();
          renderLists();
        };
        // Drag events
        li.addEventListener('dragstart', (e) => {
          if (!STATE.admin) return e.preventDefault();
          li.classList.add('dragging');
          // Find index in unsorted array
          const ix = arr.findIndex(u => u.username === user.username);
          STATE.dragSrc = { idx: ix, list: listName };
          e.dataTransfer.effectAllowed = 'move';
        });
        li.addEventListener('dragend', (e) => {
          li.classList.remove('dragging');
          STATE.dragSrc = null;
        });
        ul.appendChild(li);
      });
    }
    function renderLists() {
      renderList('nice', ui.searchNice.value);
      renderList('naughty', ui.searchNaughty.value);
    }

    // Drag-and-drop between lists
    function setupDragDrop() {
      [ui.niceList, ui.naughtyList].forEach(ul => {
        ul.addEventListener('dragover', (e) => {
          if (!STATE.admin) return;
          e.preventDefault();
          ul.style.background = '#222c';
        });
        ul.addEventListener('dragleave', (e) => {
          ul.style.background = '';
        });
        ul.addEventListener('drop', (e) => {
          if (!STATE.admin) return;
          ul.style.background = '';
          if (!STATE.dragSrc) return;
          const fromList = STATE.dragSrc.list;
          const toList = ul.dataset.list;
          if (fromList === toList) return;
          let fromArr = fromList === 'nice' ? STATE.nice : STATE.naughty;
          let toArr = toList === 'nice' ? STATE.nice : STATE.naughty;
          const moved = fromArr.splice(STATE.dragSrc.idx, 1)[0];
          toArr.push(moved);
          saveLists();
          renderLists();
        });
      });
    }

    // Sync from Firebase DB
    function syncFromFirebase() {
      const niceRef = ref(database, 'thelist/nice');
      const naughtyRef = ref(database, 'thelist/naughty');

      ui.loadingIndicator.style.display = 'block';
      onValue(niceRef, (snapshot) => {
        const val = snapshot.val();
        if (Array.isArray(val)) {
          STATE.nice = val;
          renderList('nice', ui.searchNice.value);
          ui.loadingIndicator.style.display = 'none';
        }
      });

      ui.loadingIndicator.style.display = 'block';
      onValue(naughtyRef, (snapshot) => {
        const val = snapshot.val();
        if (Array.isArray(val)) {
          STATE.naughty = val;
          renderList('naughty', ui.searchNaughty.value);
          ui.loadingIndicator.style.display = 'none';
        }
      });
    }

    // Save full lists to Firebase DB
    function saveLists() {
      set(ref(database, 'thelist'), {
        nice: STATE.nice,
        naughty: STATE.naughty
      }).catch(e => {
        ui.adminNotice.textContent = 'Error saving data: ' + e.message;
      });
    }

    // Search handlers
    ui.searchNice.addEventListener('input', () => renderList('nice', ui.searchNice.value));
    ui.searchNaughty.addEventListener('input', () => renderList('naughty', ui.searchNaughty.value));

    // Add user form
    // Twitch username validation via API
    async function isTwitchUserValid(username) {
      try {
        const res = await fetch(`https://api.ivr.fi/v2/twitch/user?login=${encodeURIComponent(username)}`);
        if (!res.ok) return false;
        const data = await res.json();
        return data[0] || false;
      } catch (e) {
        return false;
      }
    }

    ui.addUserForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!STATE.admin) {
        ui.adminNotice.textContent = 'üîí Admin login required to add users.';
        return;
      }
      const username = ui.twitchUsername.value.trim();
      if (!username.match(/^[a-zA-Z0-9_]{3,25}$/)) {
        ui.adminNotice.textContent = 'Invalid Twitch username format.';
        return;
      }

      ui.userValidationStatus.textContent = 'üîç Searching for user...';
      const twitchUser = await isTwitchUserValid(username);
      if (!twitchUser) {
        ui.userValidationStatus.textContent = '‚ùå Twitch user not found.';
        setTimeout(() => { ui.userValidationStatus.textContent = ''; }, 3000);
        return;
      } else {
        ui.userValidationStatus.textContent = '‚úÖ Twitch user found!';
      }
      const properCasedUsername = twitchUser.displayName || twitchUser.login;

      const list = ui.listChoice.value;
      const arr = list === 'nice' ? STATE.nice : STATE.naughty;
      // Prevent duplicates (case-insensitive)
      if (STATE.nice.some(u => u.username.toLowerCase() === username.toLowerCase()) ||
          STATE.naughty.some(u => u.username.toLowerCase() === username.toLowerCase())) {
        ui.adminNotice.textContent = 'User already on a list.';
        return;
      }
      arr.push({ username: properCasedUsername });
      saveLists();
      renderLists();
      ui.twitchUsername.value = '';
      ui.adminNotice.textContent = '';
      ui.userValidationStatus.textContent = '';
    };

    // Auth flow
   function setAdminMode(on, manual = false) {
      STATE.admin = on;
      if (on) {
        ui.loginBtn.classList.add('hidden');
        ui.logoutBtn.classList.remove('hidden');
        ui.addUserForm.classList.remove('hidden');
ui.adminNotice.textContent = manual
  ? 'You are logged in as admin. You can add, remove, and drag users.'
  : '';        localStorage.setItem('thelist_loggedIn', 'true');
      } else {
        ui.loginBtn.classList.remove('hidden');
        ui.logoutBtn.classList.add('hidden');
        ui.addUserForm.classList.add('hidden');
        ui.adminNotice.textContent = '';
        localStorage.removeItem('thelist_loggedIn');
      }
      renderLists();
    }
    ui.loginBtn.onclick = () => { ui.loginModal.showModal(); ui.loginError.textContent = ''; };
    ui.loginModal.addEventListener('close', () => {
      ui.loginError.textContent = '';
      ui.passwordInput.value = '';
    });
    ui.logoutBtn.onclick = () => setAdminMode(false);
    ui.loginForm.onsubmit = (e) => {
      e.preventDefault();
      const password = ui.passwordInput.value;
      if (password === '12345') {
        setAdminMode(true, true); // manual login
        ui.loginModal.close();
      } else {
        ui.loginError.textContent = '‚ùå Incorrect password';
      }
    };

    // Init
    if (STATE.loggedIn) setAdminMode(true);
    else setAdminMode(false);

    // Sync with Firebase database and render
    syncFromFirebase();
    renderLists();
    setupDragDrop();
  </script>
</body>
</html>